<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/dashboard.css" />
<link rel="stylesheet" href="/css/profile.css" />
<% if (user.role === 'admin') { %>
<link rel="stylesheet" href="/css/admin-profile.css" />
<% } %> <% if (user.role === 'admin') { %>
<!-- Admin Profile Layout -->
<div class="container mt-4 mb-5">
	<div class="row">
		<div class="col-12 mb-4">
			<div class="d-flex justify-content-between align-items-center">
				<h1 class="profile-title">Administrator Profile</h1>
				<div class="admin-quick-links">
					<a href="/admin" class="btn btn-outline-primary">
						<i class="fas fa-tachometer-alt"></i> Admin Dashboard
					</a>
					<a href="/admin/users" class="btn btn-outline-secondary">
						<i class="fas fa-users-cog"></i> User Management
					</a>
				</div>
			</div>
		</div>
	</div>

	<div class="row">
		<!-- Admin Info Card -->
		<div class="col-md-4 mb-4">
			<div class="admin-profile-card">
				<div class="admin-profile-header">
					<div class="admin-avatar">
						<% if (user.profileImage && user.profileImage.url) { %>
						<img
							src="<%= user.profileImage.url %>"
							alt="<%= user.username %>" />
						<% } else { %>
						<i class="fas fa-user-shield"></i>
						<% } %>
					</div>

					<% let fullName = user.firstName; if (user.middleName &&
					user.middleName.length > 0) { const middleInitial =
					user.middleName.charAt(0).toUpperCase(); fullName += `
					${middleInitial}.`; } fullName += ` ${user.lastName}`; %>

					<h2 class="admin-name"><%= fullName %></h2>
					<p class="admin-username">@<%= user.username %></p>
					<span class="admin-role">System Administrator</span>
				</div>

				<div class="admin-details">
					<div class="detail-item">
						<div class="detail-label"><i class="fas fa-user"></i> Username</div>
						<div class="detail-value"><%= user.username %></div>
					</div>
					<div class="detail-item">
						<div class="detail-label">
							<i class="fas fa-id-card"></i> Full Name
						</div>
						<div class="detail-value"><%= fullName %></div>
					</div>
					<div class="detail-item">
						<div class="detail-label">
							<i class="fas fa-shield-alt"></i> System Role
						</div>
						<div class="detail-value">Administrator</div>
					</div>
				</div>

				<div class="profile-actions">
					<a
						href="#editProfileModal"
						class="btn btn-primary"
						data-bs-toggle="modal">
						<i class="fas fa-edit"></i> Edit Profile
					</a>
					<a href="/profile/change-password" class="btn btn-outline-secondary">
						<i class="fas fa-key"></i> Change Password
					</a>
				</div>
			</div>
		</div>

		<!-- Admin Dashboard Summary -->
		<div class="col-md-8">
			<div class="admin-card mb-4">
				<div class="card-header">
					<h3><i class="fas fa-shield-alt"></i> Administrator Privileges</h3>
				</div>
				<div class="admin-privileges-grid">
					<div class="admin-privilege-item">
						<div class="privilege-icon">
							<i class="fas fa-users-cog"></i>
						</div>
						<div class="privilege-info">
							<h4>User Management</h4>
							<p>Create, edit, and manage user accounts</p>
						</div>
					</div>

					<div class="admin-privilege-item">
						<div class="privilege-icon">
							<i class="fas fa-clipboard-check"></i>
						</div>
						<div class="privilege-info">
							<h4>Report Approval</h4>
							<p>Review and approve/reject user reports</p>
						</div>
					</div>

					<div class="admin-privilege-item">
						<div class="privilege-icon">
							<i class="fas fa-archive"></i>
						</div>
						<div class="privilege-info">
							<h4>Archive Management</h4>
							<p>Archive and unarchive reports as needed</p>
						</div>
					</div>

					<div class="admin-privilege-item">
						<div class="privilege-icon">
							<i class="fas fa-chart-bar"></i>
						</div>
						<div class="privilege-info">
							<h4>System Statistics</h4>
							<p>Access and monitor system-wide statistics</p>
						</div>
					</div>
				</div>
			</div>

			<div class="admin-card">
				<div class="card-header">
					<h3><i class="fas fa-tachometer-alt"></i> System Overview</h3>
				</div>
				<div class="admin-stats-grid">
					<a href="/admin/users" class="admin-stat-item">
						<div class="stat-icon bg-primary-light">
							<i class="fas fa-users text-primary"></i>
						</div>
						<div class="stat-info">
							<h4>Total Users</h4>
							<span class="stat-number"><%= userCount || 0 %></span>
						</div>
					</a>

					<a href="/admin/reports" class="admin-stat-item">
						<div class="admin-stat-icon">
							<i class="fas fa-clipboard-check"></i>
						</div>
						<span class="admin-stat-label">Reports</span>
					</a>

					<a href="/admin/archived-reports" class="admin-stat-item">
						<div class="stat-icon bg-secondary-light">
							<i class="fas fa-archive text-secondary"></i>
						</div>
						<div class="stat-info">
							<h4>Archived Reports</h4>
							<span class="stat-number"><%= archivedReportsCount || 0 %></span>
						</div>
					</a>
				</div>
			</div>

			<!-- Revised Reports Notifications -->
			<% if (revisedReportNotifications && revisedReportNotifications.length >
			0) { %>
			<div class="admin-card mt-4">
				<div class="card-header">
					<h3><i class="fas fa-bell"></i> Revised Reports Notifications</h3>
				</div>
				<div class="notification-list">
					<% revisedReportNotifications.forEach(notification => { %>
					<div class="notification-item">
						<div class="notification-icon">
							<i class="fas fa-sync-alt text-info"></i>
						</div>
						<div class="notification-content">
							<p class="notification-message"><%= notification.message %></p>
							<p class="notification-time">
								<small
									><%= new Date(notification.createdAt).toLocaleString()
									%></small
								>
							</p>
						</div>
						<div class="notification-actions">
							<form
								action="/profile/notifications/<%= notification._id %>/mark-as-read"
								method="POST">
								<button type="submit" class="btn btn-sm btn-primary">
									<i class="fas fa-eye"></i> View
								</button>
							</form>
						</div>
					</div>
					<% }); %>
				</div>
			</div>
			<% } %>
		</div>
	</div>
</div>
<% } else { %>
<!-- Regular User Profile Layout -->
<div class="container mt-4 mb-5">
	<div class="row">
		<div class="col-12 mb-4">
			<h1 class="profile-title">My Profile</h1>
		</div>
	</div>

	<div class="row">
		<!-- Left Column: User Info -->
		<div class="col-md-4 mb-4">
			<div class="simple-card">
				<div class="user-profile-header">
					<div class="user-avatar">
						<% if (user.profileImage && user.profileImage.url) { %>
						<img
							src="<%= user.profileImage.url %>"
							alt="<%= user.username %>" />
						<% } else { %>
						<i class="fas fa-user-circle"></i>
						<% } %>
					</div>

					<% let fullName = user.firstName; if (user.middleName &&
					user.middleName.length > 0) { const middleInitial =
					user.middleName.charAt(0).toUpperCase(); fullName += `
					${middleInitial}.`; } fullName += ` ${user.lastName}`; %>

					<h2 class="user-name"><%= fullName %></h2>
					<p class="user-username">@<%= user.username %></p>
					<span class="user-role">Regular User</span>
				</div>

				<div class="user-details">
					<div class="detail-item">
						<div class="detail-label"><i class="fas fa-user"></i> Username</div>
						<div class="detail-value"><%= user.username %></div>
					</div>
					<div class="detail-item">
						<div class="detail-label">
							<i class="fas fa-id-card"></i> Full Name
						</div>
						<div class="detail-value"><%= fullName %></div>
					</div>
					<div class="detail-item">
						<div class="detail-label"><i class="fas fa-user"></i> Role</div>
						<div class="detail-value">Regular User</div>
					</div>
				</div>

				<div class="profile-actions">
					<a
						href="#editProfileModal"
						class="btn btn-primary"
						data-bs-toggle="modal">
						<i class="fas fa-edit"></i> Edit Profile
					</a>
					<a href="/profile/change-password" class="btn btn-outline-secondary">
						<i class="fas fa-key"></i> Change Password
					</a>
				</div>
			</div>
		</div>

		<!-- Right Column: Notifications and Reports -->
		<div class="col-md-8">
			<!-- Notifications Section -->
			<div class="simple-card mb-4">
				<div class="card-header">
					<h3><i class="fas fa-bell"></i> Notifications</h3>
					<div class="header-actions">
						<button
							class="btn btn-sm btn-outline-primary"
							id="profile-mark-all-read">
							<i class="fas fa-check-double"></i> Mark all as read
						</button>
					</div>
				</div>

				<div class="notifications-container">
					<ul class="notification-list" id="profile-notification-list">
						<!-- Notifications will be loaded here via JavaScript -->
						<div class="notification-loading">
							<i class="fas fa-spinner fa-spin"></i>
							<p>Loading notifications...</p>
						</div>
					</ul>
				</div>
			</div>

			<!-- Reports Section -->
			<div class="simple-card">
				<div class="card-header">
					<h3><i class="fas fa-file-alt"></i> Your Reports</h3>
				</div>

				<div class="report-stats">
					<a href="/weeklyreport" class="report-item">
						<i class="fas fa-calendar-week text-primary"></i>
						<div>
							<span class="report-name">Weekly Reports</span>
							<span class="report-number"
								><%= reportStats ? reportStats.weeklyReports : 0 %></span
							>
						</div>
					</a>

					<a href="/documentation" class="report-item">
						<i class="fas fa-book text-success"></i>
						<div>
							<span class="report-name">Documentation</span>
							<span class="report-number"
								><%= reportStats ? reportStats.documentation : 0 %></span
							>
						</div>
					</a>

					<a href="/timereport" class="report-item">
						<i class="fas fa-clock text-info"></i>
						<div>
							<span class="report-name">Time Reports</span>
							<span class="report-number"
								><%= reportStats ? reportStats.timeReports : 0 %></span
							>
						</div>
					</a>
				</div>
			</div>
		</div>
	</div>
</div>
<% } %>

<!-- Edit Profile Modal -->
<div
	class="modal fade"
	id="editProfileModal"
	tabindex="-1"
	aria-labelledby="editProfileModalLabel"
	aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form
					action="/profile"
					method="POST"
					class="needs-validation"
					enctype="multipart/form-data"
					novalidate>
					<div class="mb-3">
						<label for="firstName" class="form-label">First Name</label>
						<input
							type="text"
							class="form-control"
							id="firstName"
							name="firstName"
							value="<%= user.firstName %>"
							required />
						<div class="invalid-feedback">Please enter your first name</div>
					</div>
					<div class="mb-3">
						<label for="middleName" class="form-label">Middle Name</label>
						<input
							type="text"
							class="form-control"
							id="middleName"
							name="middleName"
							value="<%= user.middleName || '' %>" />
					</div>
					<div class="mb-3">
						<label for="lastName" class="form-label">Last Name</label>
						<input
							type="text"
							class="form-control"
							id="lastName"
							name="lastName"
							value="<%= user.lastName %>"
							required />
						<div class="invalid-feedback">Please enter your last name</div>
					</div>
					<div class="mb-3">
						<label for="username" class="form-label">Username</label>
						<input
							type="text"
							class="form-control"
							id="username"
							value="<%= user.username %>"
							disabled />
						<small class="text-muted">Username cannot be changed</small>
					</div>
					<div class="mb-3">
						<label for="profileImage" class="form-label">Profile Image</label>
						<input
							type="file"
							class="form-control"
							id="profileImage"
							name="profileImage"
							accept="image/jpeg,image/png,image/jpg" />
						<div class="form-text">
							Upload a new profile picture (JPG, JPEG, or PNG, max 2MB)
						</div>
						<% if (user.profileImage && user.profileImage.url) { %>
						<div class="mt-2">
							<small class="text-muted">Current profile image:</small>
							<div class="mt-1">
								<img
									src="<%= user.profileImage.url %>"
									alt="Current profile"
									class="img-thumbnail"
									style="max-width: 100px" />
							</div>
						</div>
						<% } %>
					</div>
					<div class="d-flex justify-content-end">
						<button
							type="button"
							class="btn btn-secondary me-2"
							data-bs-dismiss="modal">
							Cancel
						</button>
						<button type="submit" class="btn btn-primary">Save Changes</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script>
	// Form validation
	(function () {
		"use strict";

		// Fetch all forms we want to apply validation to
		const forms = document.querySelectorAll(".needs-validation");

		// Loop over them and prevent submission
		Array.from(forms).forEach((form) => {
			form.addEventListener(
				"submit",
				(event) => {
					if (!form.checkValidity()) {
						event.preventDefault();
						event.stopPropagation();
					}

					form.classList.add("was-validated");
				},
				false
			);
		});
	})();
</script>
