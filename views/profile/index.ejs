<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/dashboard.css" />
<link rel="stylesheet" href="/css/profile.css" />

<div class="profile-container">
	<div class="profile-header-banner">
		<div class="container">
			<h1><i class="fas fa-user-circle me-3"></i>My Profile</h1>
			<p>View and manage your profile information and notifications</p>
		</div>
	</div>

	<div class="container py-4">
		<div class="row g-4">
			<!-- Left Column: Profile Information -->
			<div class="col-lg-4">
				<div class="profile-card">
					<!-- Profile Header with gradient background based on role -->
					<div
						class="profile-header <%= user.role === 'admin' ? 'admin-profile-header' : '' %>">
						<div class="profile-avatar-wrapper">
							<div class="profile-avatar">
								<% if (user.profileImage && user.profileImage.url) { %>
								<img
									src="<%= user.profileImage.url %>"
									alt="<%= user.username %>"
									class="profile-img" />
								<% } else { %>
								<i
									class="<%= user.role === 'admin' ? 'fas fa-user-shield' : 'fas fa-user-circle' %>"></i>
								<% } %>
							</div>
						</div>

						<div class="profile-header-content">
							<h3 class="profile-name">
								<% let fullName = user.firstName; if (user.middleName &&
								user.middleName.length > 0) { const middleInitial =
								user.middleName.charAt(0).toUpperCase(); fullName += `
								${middleInitial}.`; } fullName += ` ${user.lastName}`; %> <%=
								fullName %>
							</h3>
							<span class="profile-username">@<%= user.username %></span>
							<span
								class="profile-role badge <%= user.role === 'admin' ? 'bg-danger' : 'bg-primary' %>">
								<%= user.role === 'admin' ? 'Administrator' : 'Regular User' %>
							</span>
						</div>
					</div>

					<!-- Profile Body with user information -->
					<div class="profile-body">
						<div class="profile-info">
							<div class="info-item">
								<span class="info-label">
									<i class="fas fa-user me-2"></i>Username
								</span>
								<span class="info-value"><%= user.username %></span>
							</div>
							<div class="info-item">
								<span class="info-label">
									<i class="fas fa-id-card me-2"></i>Full Name
								</span>
								<span class="info-value"><%= fullName %></span>
							</div>
							<div class="info-item">
								<span class="info-label">
									<i class="fas fa-user-shield me-2"></i>Role
								</span>
								<span class="info-value"
									><%= user.role === 'admin' ? 'Administrator' : 'Regular User'
									%></span
								>
							</div>
						</div>

						<!-- Admin Privileges Section (only for admin users) -->
						<% if (user.role === 'admin') { %>
						<div class="admin-info mt-4 mb-4">
							<div class="admin-info-header">
								<i class="fas fa-shield-alt me-2"></i> Administrator Privileges
							</div>
							<ul class="admin-privileges-list">
								<li>
									<i class="fas fa-check-circle text-success me-2"></i> Manage
									user accounts
								</li>
								<li>
									<i class="fas fa-check-circle text-success me-2"></i>
									Approve/reject reports
								</li>
								<li>
									<i class="fas fa-check-circle text-success me-2"></i>
									Archive/unarchive reports
								</li>
								<li>
									<i class="fas fa-check-circle text-success me-2"></i> Access
									system statistics
								</li>
							</ul>
						</div>
						<% } %>

						<!-- Profile Action Buttons -->
						<div
							class="profile-actions <%= user.role === 'admin' ? '' : 'mt-4' %>">
							<a
								href="#editProfileModal"
								class="btn btn-primary w-100 mb-3"
								data-bs-toggle="modal">
								<i class="fas fa-edit me-2"></i>Edit Profile
							</a>
							<a
								href="/profile/change-password"
								class="btn btn-outline-secondary w-100">
								<i class="fas fa-key me-2"></i>Change Password
							</a>
						</div>
					</div>
				</div>
			</div>

			<!-- Right Column: Notifications and Reports -->
			<% if (user.role !== 'admin') { %>
			<div class="col-lg-8">
				<!-- Notifications Card -->
				<div class="notifications-card mb-4">
					<div class="card-header-with-actions">
						<h3><i class="fas fa-bell me-2"></i>Notifications</h3>
						<div class="notification-actions">
							<button
								class="btn btn-sm btn-outline-primary"
								id="profile-mark-all-read">
								<i class="fas fa-check-double me-1"></i> Mark all as read
							</button>
							<a href="/dashboard" class="btn btn-sm btn-outline-secondary">
								<i class="fas fa-tachometer-alt me-1"></i> Dashboard
							</a>
						</div>
					</div>

					<!-- Notifications List -->
					<div class="profile-notifications-container">
						<ul class="notification-list" id="profile-notification-list">
							<!-- Notifications will be loaded here via JavaScript -->
							<div class="notification-loading">
								<i class="fas fa-spinner fa-spin"></i>
								<p>Loading notifications...</p>
							</div>
						</ul>
					</div>
				</div>

				<!-- Report Summary Card -->
				<div class="reports-card">
					<div class="card-header">
						<h3><i class="fas fa-file-alt me-2"></i>Your Reports</h3>
					</div>
					<div class="report-summary-grid">
						<a href="/weeklyreport" class="report-summary-item">
							<div class="report-icon bg-primary-light">
								<i class="fas fa-file-alt text-primary"></i>
							</div>
							<div class="report-info">
								<h4>Weekly Reports</h4>
								<span class="report-count"
									><%= reportStats ? reportStats.weeklyReports : 0 %></span
								>
							</div>
						</a>
						<a href="/weeklyprogress" class="report-summary-item">
							<div class="report-icon bg-purple-light">
								<i class="fas fa-tasks text-purple"></i>
							</div>
							<div class="report-info">
								<h4>Weekly Progress</h4>
								<span class="report-count"
									><%= reportStats ? reportStats.weeklyProgress : 0 %></span
								>
							</div>
						</a>
						<a href="/trainingschedule" class="report-summary-item">
							<div class="report-icon bg-teal-light">
								<i class="fas fa-calendar-alt text-teal"></i>
							</div>
							<div class="report-info">
								<h4>Training Schedules</h4>
								<span class="report-count"
									><%= reportStats ? reportStats.trainingSchedule : 0 %></span
								>
							</div>
						</a>
						<a href="/learningoutcome" class="report-summary-item">
							<div class="report-icon bg-orange-light">
								<i class="fas fa-graduation-cap text-orange"></i>
							</div>
							<div class="report-info">
								<h4>Learning Outcomes</h4>
								<span class="report-count"
									><%= reportStats ? reportStats.learningOutcome : 0 %></span
								>
							</div>
						</a>
						<a href="/dailyattendance" class="report-summary-item">
							<div class="report-icon bg-indigo-light">
								<i class="fas fa-clipboard-check text-indigo"></i>
							</div>
							<div class="report-info">
								<h4>Daily Attendance</h4>
								<span class="report-count"
									><%= reportStats ? reportStats.dailyAttendance : 0 %></span
								>
							</div>
						</a>
						<a href="/documentation" class="report-summary-item">
							<div class="report-icon bg-success-light">
								<i class="fas fa-book text-success"></i>
							</div>
							<div class="report-info">
								<h4>Documentation</h4>
								<span class="report-count"
									><%= reportStats ? reportStats.documentation : 0 %></span
								>
							</div>
						</a>
						<a href="/timereport" class="report-summary-item">
							<div class="report-icon bg-info-light">
								<i class="fas fa-clock text-info"></i>
							</div>
							<div class="report-info">
								<h4>Time Reports</h4>
								<span class="report-count"
									><%= reportStats ? reportStats.timeReports : 0 %></span
								>
							</div>
						</a>
					</div>
				</div>
			</div>
			<% } %>
		</div>
	</div>
</div>

<!-- Edit Profile Modal -->
<div
	class="modal fade"
	id="editProfileModal"
	tabindex="-1"
	aria-labelledby="editProfileModalLabel"
	aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form
					action="/profile"
					method="POST"
					class="needs-validation"
					enctype="multipart/form-data"
					novalidate>
					<div class="mb-3">
						<label for="firstName" class="form-label">First Name</label>
						<input
							type="text"
							class="form-control"
							id="firstName"
							name="firstName"
							value="<%= user.firstName %>"
							required />
						<div class="invalid-feedback">Please enter your first name</div>
					</div>
					<div class="mb-3">
						<label for="middleName" class="form-label">Middle Name</label>
						<input
							type="text"
							class="form-control"
							id="middleName"
							name="middleName"
							value="<%= user.middleName || '' %>" />
					</div>
					<div class="mb-3">
						<label for="lastName" class="form-label">Last Name</label>
						<input
							type="text"
							class="form-control"
							id="lastName"
							name="lastName"
							value="<%= user.lastName %>"
							required />
						<div class="invalid-feedback">Please enter your last name</div>
					</div>
					<div class="mb-3">
						<label for="username" class="form-label">Username</label>
						<input
							type="text"
							class="form-control"
							id="username"
							value="<%= user.username %>"
							disabled />
						<small class="text-muted">Username cannot be changed</small>
					</div>
					<div class="mb-3">
						<label for="profileImage" class="form-label">Profile Image</label>
						<input
							type="file"
							class="form-control"
							id="profileImage"
							name="profileImage"
							accept="image/jpeg,image/png,image/jpg" />
						<div class="form-text">
							Upload a new profile picture (JPG, JPEG, or PNG, max 2MB)
						</div>
						<% if (user.profileImage && user.profileImage.url) { %>
						<div class="mt-2">
							<small class="text-muted">Current profile image:</small>
							<div class="mt-1">
								<img
									src="<%= user.profileImage.url %>"
									alt="Current profile"
									class="img-thumbnail"
									style="max-width: 100px" />
							</div>
						</div>
						<% } %>
					</div>
					<div class="d-flex justify-content-end">
						<button
							type="button"
							class="btn btn-secondary me-2"
							data-bs-dismiss="modal">
							Cancel
						</button>
						<button type="submit" class="btn btn-primary">Save Changes</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script>
	// Form validation
	(function () {
		"use strict";

		// Fetch all forms we want to apply validation to
		const forms = document.querySelectorAll(".needs-validation");

		// Loop over them and prevent submission
		Array.from(forms).forEach((form) => {
			form.addEventListener(
				"submit",
				(event) => {
					if (!form.checkValidity()) {
						event.preventDefault();
						event.stopPropagation();
					}

					form.classList.add("was-validated");
				},
				false
			);
		});
	})();
</script>
