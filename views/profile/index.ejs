<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/dashboard.css" />
<link rel="stylesheet" href="/css/profile.css" />

<div class="container mt-4 mb-5">
	<div class="row">
		<div class="col-12 mb-4">
			<h1 class="profile-title">My Profile</h1>
		</div>
	</div>

	<div class="row">
		<!-- Left Column: User Info -->
		<div class="col-md-4 mb-4">
			<div class="simple-card">
				<div class="user-profile-header">
					<div class="user-avatar">
						<% if (user.profileImage && user.profileImage.url) { %>
						<img
							src="<%= user.profileImage.url %>"
							alt="<%= user.username %>" />
						<% } else { %>
						<i
							class="<%= user.role === 'admin' ? 'fas fa-user-shield' : 'fas fa-user-circle' %>"></i>
						<% } %>
					</div>

					<% let fullName = user.firstName; if (user.middleName &&
					user.middleName.length > 0) { const middleInitial =
					user.middleName.charAt(0).toUpperCase(); fullName += `
					${middleInitial}.`; } fullName += ` ${user.lastName}`; %>

					<h2 class="user-name"><%= fullName %></h2>
					<p class="user-username">@<%= user.username %></p>
					<span
						class="user-role <%= user.role === 'admin' ? 'admin-role' : 'user-role' %>">
						<%= user.role === 'admin' ? 'Administrator' : 'Regular User' %>
					</span>
				</div>

				<div class="user-details">
					<div class="detail-item">
						<div class="detail-label"><i class="fas fa-user"></i> Username</div>
						<div class="detail-value"><%= user.username %></div>
					</div>
					<div class="detail-item">
						<div class="detail-label">
							<i class="fas fa-id-card"></i> Full Name
						</div>
						<div class="detail-value"><%= fullName %></div>
					</div>
					<div class="detail-item">
						<div class="detail-label">
							<i class="fas fa-user-shield"></i> Role
						</div>
						<div class="detail-value">
							<%= user.role === 'admin' ? 'Administrator' : 'Regular User' %>
						</div>
					</div>
				</div>

				<% if (user.role === 'admin') { %>
				<div class="admin-privileges">
					<h3><i class="fas fa-shield-alt"></i> Admin Privileges</h3>
					<ul>
						<li><i class="fas fa-check-circle"></i> Manage user accounts</li>
						<li><i class="fas fa-check-circle"></i> Approve/reject reports</li>
						<li>
							<i class="fas fa-check-circle"></i> Archive/unarchive reports
						</li>
						<li>
							<i class="fas fa-check-circle"></i> Access system statistics
						</li>
					</ul>
				</div>
				<% } %>

				<div class="profile-actions">
					<a
						href="#editProfileModal"
						class="btn btn-primary"
						data-bs-toggle="modal">
						<i class="fas fa-edit"></i> Edit Profile
					</a>
					<a href="/profile/change-password" class="btn btn-outline-secondary">
						<i class="fas fa-key"></i> Change Password
					</a>
				</div>
			</div>
		</div>

		<!-- Right Column: Notifications and Reports -->
		<% if (user.role !== 'admin') { %>
		<div class="col-md-8">
			<!-- Notifications Section -->
			<div class="simple-card mb-4">
				<div class="card-header">
					<h3><i class="fas fa-bell"></i> Notifications</h3>
					<div class="header-actions">
						<button
							class="btn btn-sm btn-outline-primary"
							id="profile-mark-all-read">
							<i class="fas fa-check-double"></i> Mark all as read
						</button>
					</div>
				</div>

				<div class="notifications-container">
					<ul class="notification-list" id="profile-notification-list">
						<!-- Notifications will be loaded here via JavaScript -->
						<div class="notification-loading">
							<i class="fas fa-spinner fa-spin"></i>
							<p>Loading notifications...</p>
						</div>
					</ul>
				</div>
			</div>

			<!-- Reports Section -->
			<div class="simple-card">
				<div class="card-header">
					<h3><i class="fas fa-file-alt"></i> Your Reports</h3>
				</div>

				<div class="reports-grid">
					<a href="/weeklyreport" class="report-item">
						<i class="fas fa-file-alt text-primary"></i>
						<div>
							<span class="report-name">Weekly Reports</span>
							<span class="report-number"
								><%= reportStats ? reportStats.weeklyReports : 0 %></span
							>
						</div>
					</a>

					<a href="/weeklyprogress" class="report-item">
						<i class="fas fa-tasks text-purple"></i>
						<div>
							<span class="report-name">Weekly Progress</span>
							<span class="report-number"
								><%= reportStats ? reportStats.weeklyProgress : 0 %></span
							>
						</div>
					</a>

					<a href="/trainingschedule" class="report-item">
						<i class="fas fa-calendar-alt text-teal"></i>
						<div>
							<span class="report-name">Training Schedules</span>
							<span class="report-number"
								><%= reportStats ? reportStats.trainingSchedule : 0 %></span
							>
						</div>
					</a>

					<a href="/learningoutcome" class="report-item">
						<i class="fas fa-graduation-cap text-orange"></i>
						<div>
							<span class="report-name">Learning Outcomes</span>
							<span class="report-number"
								><%= reportStats ? reportStats.learningOutcome : 0 %></span
							>
						</div>
					</a>

					<a href="/dailyattendance" class="report-item">
						<i class="fas fa-clipboard-check text-indigo"></i>
						<div>
							<span class="report-name">Daily Attendance</span>
							<span class="report-number"
								><%= reportStats ? reportStats.dailyAttendance : 0 %></span
							>
						</div>
					</a>

					<a href="/documentation" class="report-item">
						<i class="fas fa-book text-success"></i>
						<div>
							<span class="report-name">Documentation</span>
							<span class="report-number"
								><%= reportStats ? reportStats.documentation : 0 %></span
							>
						</div>
					</a>

					<a href="/timereport" class="report-item">
						<i class="fas fa-clock text-info"></i>
						<div>
							<span class="report-name">Time Reports</span>
							<span class="report-number"
								><%= reportStats ? reportStats.timeReports : 0 %></span
							>
						</div>
					</a>
				</div>
			</div>
		</div>
		<% } %>
	</div>
</div>

<!-- Edit Profile Modal -->
<div
	class="modal fade"
	id="editProfileModal"
	tabindex="-1"
	aria-labelledby="editProfileModalLabel"
	aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form
					action="/profile"
					method="POST"
					class="needs-validation"
					enctype="multipart/form-data"
					novalidate>
					<div class="mb-3">
						<label for="firstName" class="form-label">First Name</label>
						<input
							type="text"
							class="form-control"
							id="firstName"
							name="firstName"
							value="<%= user.firstName %>"
							required />
						<div class="invalid-feedback">Please enter your first name</div>
					</div>
					<div class="mb-3">
						<label for="middleName" class="form-label">Middle Name</label>
						<input
							type="text"
							class="form-control"
							id="middleName"
							name="middleName"
							value="<%= user.middleName || '' %>" />
					</div>
					<div class="mb-3">
						<label for="lastName" class="form-label">Last Name</label>
						<input
							type="text"
							class="form-control"
							id="lastName"
							name="lastName"
							value="<%= user.lastName %>"
							required />
						<div class="invalid-feedback">Please enter your last name</div>
					</div>
					<div class="mb-3">
						<label for="username" class="form-label">Username</label>
						<input
							type="text"
							class="form-control"
							id="username"
							value="<%= user.username %>"
							disabled />
						<small class="text-muted">Username cannot be changed</small>
					</div>
					<div class="mb-3">
						<label for="profileImage" class="form-label">Profile Image</label>
						<input
							type="file"
							class="form-control"
							id="profileImage"
							name="profileImage"
							accept="image/jpeg,image/png,image/jpg" />
						<div class="form-text">
							Upload a new profile picture (JPG, JPEG, or PNG, max 2MB)
						</div>
						<% if (user.profileImage && user.profileImage.url) { %>
						<div class="mt-2">
							<small class="text-muted">Current profile image:</small>
							<div class="mt-1">
								<img
									src="<%= user.profileImage.url %>"
									alt="Current profile"
									class="img-thumbnail"
									style="max-width: 100px" />
							</div>
						</div>
						<% } %>
					</div>
					<div class="d-flex justify-content-end">
						<button
							type="button"
							class="btn btn-secondary me-2"
							data-bs-dismiss="modal">
							Cancel
						</button>
						<button type="submit" class="btn btn-primary">Save Changes</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script>
	// Form validation
	(function () {
		"use strict";

		// Fetch all forms we want to apply validation to
		const forms = document.querySelectorAll(".needs-validation");

		// Loop over them and prevent submission
		Array.from(forms).forEach((form) => {
			form.addEventListener(
				"submit",
				(event) => {
					if (!form.checkValidity()) {
						event.preventDefault();
						event.stopPropagation();
					}

					form.classList.add("was-validated");
				},
				false
			);
		});
	})();
</script>
