<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/dashboard.css" />
<link rel="stylesheet" href="/css/reportModals.css" />

<div class="dashboard-container">
	<div class="welcome-section">
		<h1>Pending Reports</h1>
		<p>Review and approve submitted reports</p>
	</div>

	<div class="dashboard-card full-width">
		<!-- Filter Section -->
		<div class="filter-section mb-4">
			<h4 class="mb-3">Filter Reports</h4>
			<form id="filterForm" class="row g-3">
				<div class="col-md-3">
					<label for="reportType" class="form-label">Report Type</label>
					<select class="form-select" id="reportType" name="reportType">
						<option value="all" <%= filters && filters.reportType === 'all' ? 'selected' : '' %>>All Types</option>
						<option value="weeklyreport" <%= filters && filters.reportType === 'weeklyreport' ? 'selected' : '' %>>Weekly Report</option>
						<option value="weeklyprogress" <%= filters && filters.reportType === 'weeklyprogress' ? 'selected' : '' %>>Weekly Progress Report</option>
						<option value="trainingschedule" <%= filters && filters.reportType === 'trainingschedule' ? 'selected' : '' %>>Training Schedule</option>
						<option value="learningoutcome" <%= filters && filters.reportType === 'learningoutcome' ? 'selected' : '' %>>Learning Outcome</option>
						<option value="dailyattendance" <%= filters && filters.reportType === 'dailyattendance' ? 'selected' : '' %>>Daily Attendance</option>
						<option value="documentation" <%= filters && filters.reportType === 'documentation' ? 'selected' : '' %>>Documentation</option>
						<option value="timereport" <%= filters && filters.reportType === 'timereport' ? 'selected' : '' %>>Time Report</option>
					</select>
				</div>
				<div class="col-md-3">
					<label for="studentName" class="form-label">Student Name</label>
					<input
						type="text"
						class="form-control"
						id="studentName"
						name="studentName"
						placeholder="Search by name" />
				</div>
				<div class="col-md-3">
					<label for="internshipSite" class="form-label">Internship Site</label>
					<input
						type="text"
						class="form-control"
						id="internshipSite"
						name="internshipSite"
						placeholder="Search by site" />
				</div>
				<div class="col-md-3">
					<label for="weekPeriod" class="form-label">Week Period</label>
					<input
						type="date"
						class="form-control"
						id="weekPeriod"
						name="weekPeriod" />
				</div>
				<div class="col-md-3">
					<label for="sortBy" class="form-label">Sort By</label>
					<select class="form-select" id="sortBy" name="sortBy">
						<option value="dateSubmitted_desc">Date (Newest First)</option>
						<option value="dateSubmitted_asc">Date (Oldest First)</option>
						<option value="studentName_asc">Student Name (A-Z)</option>
						<option value="studentName_desc">Student Name (Z-A)</option>
						<option value="internshipSite_asc">Internship Site (A-Z)</option>
					</select>
				</div>
				<div class="col-md-3 d-flex align-items-end">
					<button type="submit" class="btn btn-primary me-2">
						Apply Filters
					</button>
					<button type="reset" class="btn btn-secondary">Reset</button>
				</div>
			</form>
		</div>

		<% if (pendingReports && pendingReports.length) { %>
		<div class="table-responsive">
			<table class="table table-hover">
				<thead>
					<tr>
						<th>Report Type</th>
						<th>Student Name</th>
						<th>Submitted By</th>
						<th>Internship Site</th>
						<th>Period</th>
						<th>Date Submitted</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					<% pendingReports.forEach(report => { %>
					<tr>
						<td>
							<% if (report.reportType === 'weeklyreport') { %>
								<span class="badge bg-primary">Weekly Report</span>
							<% } else if (report.reportType === 'weeklyprogress') { %>
								<span class="badge bg-purple">Weekly Progress</span>
							<% } else if (report.reportType === 'trainingschedule') { %>
								<span class="badge bg-teal">Training Schedule</span>
							<% } else if (report.reportType === 'learningoutcome') { %>
								<span class="badge bg-orange">Learning Outcome</span>
							<% } else if (report.reportType === 'dailyattendance') { %>
								<span class="badge bg-indigo">Daily Attendance</span>
							<% } else if (report.reportType === 'documentation') { %>
								<span class="badge bg-success">Documentation</span>
							<% } else if (report.reportType === 'timereport') { %>
								<span class="badge bg-info">Time Report</span>
							<% } else { %>
								<span class="badge bg-secondary">Other</span>
							<% } %>
						</td>
						<td><%= report.studentName %></td>
						<td><%= report.authorFullName || 'Unknown' %></td>
						<td><%= report.internshipSite %></td>
						<td>
							<% if (report.weekStartDate && report.weekEndDate) { %>
								<%= new Date(report.weekStartDate).toLocaleDateString() %> - <%= new Date(report.weekEndDate).toLocaleDateString() %>
							<% } else if (report.date) { %>
								<%= new Date(report.date).toLocaleDateString() %>
							<% } else { %>
								N/A
							<% } %>
						</td>
						<td><%= new Date(report.dateSubmitted).toLocaleDateString() %></td>
						<td>
							<div class="btn-group" role="group">
								<a
									href="/<%= report.reportType %>/<%= report._id %>"
									class="btn btn-sm btn-info text-white">
									<i class="fas fa-eye"></i> View
								</a>
								<button
									type="button"
									class="btn btn-sm btn-success"
									data-bs-toggle="modal"
									data-bs-target="#approveModal-<%= report.reportType %>-<%= report._id %>">
									<i class="fas fa-check"></i> Approve
								</button>
								<button
									type="button"
									class="btn btn-sm btn-danger"
									data-bs-toggle="modal"
									data-bs-target="#rejectModal-<%= report.reportType %>-<%= report._id %>">
									<i class="fas fa-times"></i> Reject
								</button>
							</div>

							<!-- Approve Modal -->
							<div
								class="modal fade report-modal"
								id="approveModal-<%= report.reportType %>-<%= report._id %>"
								tabindex="-1"
								aria-labelledby="approveModalLabel-<%= report.reportType %>-<%= report._id %>"
								aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered">
									<div class="modal-content">
										<div
											class="modal-header"
											style="
												background: linear-gradient(135deg, #28c76f, #1f9d57);
												color: white;
											">
											<h5
												class="modal-title"
												id="approveModalLabel-<%= report.reportType %>-<%= report._id %>">
												<i class="fas fa-check me-2"></i> Approve Report
											</h5>
											<button
												type="button"
												class="btn-close btn-close-white"
												data-bs-dismiss="modal"
												aria-label="Close"></button>
										</div>
										<form
											action="/admin/reports/<%= report.reportType %>/<%= report._id %>/approve"
											method="POST"
											id="approveForm-<%= report.reportType %>-<%= report._id %>">
											<div class="modal-body">
												<div class="text-center mb-4">
													<div
														style="
															font-size: 4rem;
															color: #28c76f;
															margin-bottom: 1rem;
														">
														<i class="fas fa-check-circle"></i>
													</div>
													<h4 style="font-weight: 600; color: #333">
														Approve this report?
													</h4>
													<p class="text-muted">
														This action will mark the report as approved and
														notify the student.
													</p>
												</div>
												<input type="hidden" name="status" value="approved" />
												<div class="form-group mb-3">
													<label
														for="approveComments-<%= report.reportType %>-<%= report._id %>"
														class="form-label"
														style="font-weight: 600; color: #333"
														>Comments (Optional):</label
													>
													<textarea
														class="form-control"
														id="approveComments-<%= report.reportType %>-<%= report._id %>"
														name="adminComments"
														rows="4"
														placeholder="Add any feedback or comments about this report"
														style="
															border: 2px solid #e9ecef;
															border-radius: 12px;
															padding: 1rem;
														"
														maxlength="500"></textarea>
													<span
														class="char-counter"
														id="approveCharCounter-<%= report.reportType %>-<%= report._id %>"
														style="
															display: block;
															text-align: right;
															font-size: 0.85rem;
															color: #6c757d;
															margin-top: 0.5rem;
														"
														>0/500 characters</span
													>
												</div>
											</div>
											<div class="modal-footer">
												<button
													type="button"
													class="btn btn-outline-secondary"
													data-bs-dismiss="modal">
													Cancel
												</button>
												<button
													type="submit"
													class="btn btn-success"
													style="
														background: linear-gradient(
															135deg,
															#28c76f,
															#1f9d57
														);
														border: none;
														padding: 0.75rem 1.5rem;
														font-weight: 600;
														border-radius: 8px;
													">
													<i class="fas fa-check me-2"></i> Approve Report
												</button>
											</div>
										</form>
									</div>
								</div>
							</div>

							<!-- Reject Modal -->
							<div
								class="modal fade report-modal"
								id="rejectModal-<%= report.reportType %>-<%= report._id %>"
								tabindex="-1"
								aria-labelledby="rejectModalLabel-<%= report.reportType %>-<%= report._id %>"
								aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered">
									<div class="modal-content">
										<div
											class="modal-header"
											style="
												background: linear-gradient(135deg, #ea5455, #c62a2b);
												color: white;
											">
											<h5
												class="modal-title"
												id="rejectModalLabel-<%= report.reportType %>-<%= report._id %>">
												<i class="fas fa-times me-2"></i> Reject Report
											</h5>
											<button
												type="button"
												class="btn-close btn-close-white"
												data-bs-dismiss="modal"
												aria-label="Close"></button>
										</div>
										<form
											action="/admin/reports/<%= report.reportType %>/<%= report._id %>/approve"
											method="POST"
											id="rejectForm-<%= report.reportType %>-<%= report._id %>">
											<div class="modal-body">
												<div class="text-center mb-4">
													<div
														style="
															font-size: 4rem;
															color: #ea5455;
															margin-bottom: 1rem;
														">
														<i class="fas fa-times-circle"></i>
													</div>
													<h4 style="font-weight: 600; color: #333">
														Reject this report?
													</h4>
													<p class="text-muted">
														This action will mark the report as rejected and
														notify the student.
													</p>
												</div>
												<input type="hidden" name="status" value="rejected" />
												<div class="form-group mb-3">
													<label
														for="rejectComments-<%= report.reportType %>-<%= report._id %>"
														class="form-label"
														style="font-weight: 600; color: #333">
														Reason for Rejection
														<span class="text-danger">*</span>
													</label>
													<textarea
														class="form-control"
														id="rejectComments-<%= report.reportType %>-<%= report._id %>"
														name="adminComments"
														rows="4"
														placeholder="Please provide a detailed explanation of why this report is being rejected"
														required
														style="
															border: 2px solid #e9ecef;
															border-radius: 12px;
															padding: 1rem;
														"
														maxlength="500"></textarea>
													<span
														class="char-counter"
														id="rejectCharCounter-<%= report.reportType %>-<%= report._id %>"
														style="
															display: block;
															text-align: right;
															font-size: 0.85rem;
															color: #6c757d;
															margin-top: 0.5rem;
														"
														>0/500 characters</span
													>
												</div>
											</div>
											<div class="modal-footer">
												<button
													type="button"
													class="btn btn-outline-secondary"
													data-bs-dismiss="modal">
													Cancel
												</button>
												<button
													type="submit"
													class="btn btn-danger"
													style="
														background: linear-gradient(
															135deg,
															#ea5455,
															#c62a2b
														);
														border: none;
														padding: 0.75rem 1.5rem;
														font-weight: 600;
														border-radius: 8px;
													">
													<i class="fas fa-times me-2"></i> Reject Report
												</button>
											</div>
										</form>
									</div>
								</div>
							</div>
						</td>
					</tr>
					<% }) %>
				</tbody>
			</table>
		</div>
		<% } else { %>
		<div class="alert alert-info text-center">
			<i class="fas fa-info-circle me-2"></i>
			No pending reports found. All reports have been reviewed.
		</div>
		<% } %>
	</div>
</div>

<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
	crossorigin="anonymous"></script>

<script src="/js/reportFilters.js"></script>
<script src="/js/reportModals.js"></script>

<style>
.bg-purple {
	background: linear-gradient(135deg, #9b59b6, #8e44ad);
}

.bg-teal {
	background: linear-gradient(135deg, #1abc9c, #16a085);
}

.bg-orange {
	background: linear-gradient(135deg, #e67e22, #d35400);
}

.bg-indigo {
	background: linear-gradient(135deg, #4a69bd, #1e3799);
}
</style>
