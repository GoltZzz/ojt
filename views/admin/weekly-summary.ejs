<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/weeklySummary.css" />
<link rel="stylesheet" href="/css/dashboard.css" />

<div class="dashboard-container">
	<% if (loopActive) { %>
	<div
		class="alert alert-success d-flex align-items-center justify-content-center mb-4"
		role="alert">
		<i class="fa-solid fa-circle-check me-2"></i>
		<strong>Weekly Loop is ACTIVE.</strong> Students can submit their weekly
		reports as scheduled.
	</div>
	<% } %>
	<div class="welcome-section">
		<h1><i class="fa-solid fa-calendar-week me-2"></i>Weekly Report Summary</h1>
		<div class="card shadow-sm mb-4">
			<div class="card-body">
				<div class="d-flex justify-content-between align-items-center mb-3">
					<% if (!loopActive) { %>
					<form
						id="start-weekly-loop-form"
						method="POST"
						action="/admin/weekly-summary/start"
						class="row g-3 align-items-center flex-grow-1">
						<% if (!(weeks && weeks.length)) { %>
						<div class="col-12 mb-2">
							<label for="startDate" class="form-label fw-semibold"
								>Select Start Date
								<span class="text-muted">(Monday)</span>:</label
							>
							<input
								type="date"
								id="startDate"
								name="startDate"
								class="form-control"
								required />
						</div>
						<% } %>
						<div class="col-12">
							<button type="submit" class="btn btn-primary w-100">
								<i class="fa-solid fa-play"></i> Start Weekly Loop
							</button>
						</div>
					</form>
					<% } else { %>
					<div class="d-flex gap-2 w-100">
						<form
							method="POST"
							action="/admin/weekly-summary/stop"
							class="flex-grow-1">
							<button type="submit" class="btn btn-danger w-100">
								<i class="fa-solid fa-stop"></i> Stop Loop
							</button>
						</form>
						<button
							type="button"
							class="btn btn-warning"
							data-bs-toggle="modal"
							data-bs-target="#restartModal">
							<i class="fa-solid fa-sync"></i> Restart Loop
						</button>
						<form method="POST" action="/admin/force-next-week" class="ms-2">
							<button type="submit" class="btn btn-info">
								<i class="fa-solid fa-forward"></i> Add New Week
							</button>
						</form>
					</div>
					<% } %>
				</div>
			</div>
		</div>
	</div>

	<!-- Restart Modal -->
	<div
		class="modal fade"
		id="restartModal"
		tabindex="-1"
		aria-labelledby="restartModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="restartModalLabel">
						Restart Weekly Loop
					</h5>
					<button
						type="button"
						class="btn-close"
						data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<form method="POST" action="/admin/weekly-summary/restart">
					<div class="modal-body">
						<div class="alert alert-warning">
							<i class="fas fa-exclamation-triangle"></i>
							<strong>Warning:</strong> This will delete all existing weeks and
							reports. This action cannot be undone.
						</div>
						<div class="mb-3">
							<label for="restartDate" class="form-label"
								>Select New Start Date (Monday):</label
							>
							<input
								type="date"
								class="form-control"
								id="restartDate"
								name="startDate"
								required />
						</div>
					</div>
					<div class="modal-footer">
						<button
							type="button"
							class="btn btn-secondary"
							data-bs-dismiss="modal">
							Cancel
						</button>
						<button type="submit" class="btn btn-warning">
							<i class="fa-solid fa-sync"></i> Restart Loop
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<% if (weeks && weeks.length) { %>
	<div class="dashboard-card full-width mt-4">
		<h3 class="mb-3">
			<i class="fa-solid fa-list-check me-2" style="color: var(--accent)"></i
			>Weekly Submission Status
		</h3>

		<div class="table-responsive">
			<table
				class="table table-bordered table-hover align-middle"
				id="summaryTable">
				<thead>
					<tr>
						<th>Week #</th>
						<th>Date Range</th>
						<% students.forEach(student => { %>
						<th>
							<i class="fa-solid fa-user"></i> <%= student.firstName %> <%=
							student.lastName %>
						</th>
						<% }) %>
					</tr>
				</thead>
				<tbody>
					<% weeks.forEach((week, i) => { %>
					<tr class="week-row" data-week="<%= i + 1 %>">
						<td class="fw-bold">Week <%= i + 1 %></td>
						<td>
							<span class="badge bg-light text-dark border"
								><%= week.startLabel %> â€“ <%= week.endLabel %></span
							>
						</td>
						<% students.forEach(student => { %>
						<td
							class="text-center student-cell"
							data-student="<%= student.firstName %> <%= student.lastName %>"
							data-date="<%= week.startLabel %>">
							<% const status = week.submissions[student._id]; %> <% if (status
							&& status.submitted) { %>
							<div class="submission-status" data-status="<%= status.status %>">
								<% if (status.status === 'approved') { %>
								<span class="text-success"
									><i class="fas fa-check-circle fa-lg"></i
								></span>
								<small class="d-block text-success mt-1">Approved</small>
								<% } else if (status.status === 'rejected') { %>
								<span class="text-danger"
									><i class="fas fa-times-circle fa-lg"></i
								></span>
								<small class="d-block text-danger mt-1">Rejected</small>
								<% } else { %>
								<span class="text-warning"
									><i class="fas fa-clock fa-lg"></i
								></span>
								<small class="d-block text-warning mt-1">Pending</small>
								<% } %>
								<small class="d-block text-muted mt-1">
									<%= new Date(status.submittedAt).toLocaleDateString() %>
								</small>
							</div>
							<% } else { %>
							<div class="submission-status" data-status="notSubmitted">
								<span class="text-danger"
									><i class="fa-solid fa-xmark"></i
								></span>
								<small class="d-block text-muted mt-1">No Submission</small>
							</div>
							<% } %>
						</td>
						<% }) %>
					</tr>
					<% }) %>
				</tbody>
			</table>
		</div>
	</div>
	<% } %>
</div>

<script>
	// Validate restart date is a Monday
	document
		.getElementById("restartDate")
		.addEventListener("change", function () {
			const date = new Date(this.value);
			if (date.getDay() !== 1) {
				// 1 is Monday
				alert("Please select a Monday as the start date.");
				this.value = "";
			}
		});
</script>
