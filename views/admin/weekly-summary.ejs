<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/weeklySummary.css" />
<link rel="stylesheet" href="/css/dashboard.css" />

<div class="dashboard-container">
  <% if (loopActive) { %>
    <div class="alert alert-success d-flex align-items-center justify-content-center mb-4" role="alert">
      <i class="fa-solid fa-circle-check me-2"></i>
      <strong>Weekly Loop is ACTIVE.</strong> Students can submit their weekly reports as scheduled.
    </div>
  <% } %>
  <div class="welcome-section">
    <h1><i class="fa-solid fa-calendar-week me-2"></i>Weekly Report Summary</h1>
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <% if (!loopActive) { %>
          <form id="start-weekly-loop-form" method="POST" action="/admin/weekly-summary/start" class="row g-3 align-items-center">
            <% if (!(weeks && weeks.length)) { %>
              <div class="col-12 mb-2">
                <label for="startDate" class="form-label fw-semibold">Select Start Date <span class="text-muted">(Monday)</span>:</label>
                <input type="date" id="startDate" name="startDate" class="form-control" required />
              </div>
            <% } %>
            <div class="col-12 d-flex justify-content-between">
              <button type="submit" class="btn btn-primary w-100">
                <i class="fa-solid fa-play"></i> Start Weekly Loop
              </button>
            </div>
          </form>
        <% } else { %>
          <div class="d-flex justify-content-center">
            <form method="POST" action="/admin/weekly-summary/stop">
              <button type="submit" class="btn btn-danger w-100">
                <i class="fa-solid fa-stop"></i> Stop Loop
              </button>
            </form>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <% if (weeks && weeks.length) { %>
    <div class="dashboard-card full-width mt-4">
      <h3 class="mb-3"><i class="fa-solid fa-list-check me-2" style="color:var(--accent)"></i>Weekly Submission Status</h3>
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
          <thead>
            <tr>
              <th>Week #</th>
              <th>Date Range</th>
              <% students.forEach(student => { %>
                <th><i class="fa-solid fa-user"></i> <%= student.firstName %> <%= student.lastName %></th>
              <% }) %>
            </tr>
          </thead>
          <tbody>
            <% weeks.forEach((week, i) => { %>
              <tr>
                <td class="fw-bold">Week <%= i + 1 %></td>
                <td><span class="badge bg-light text-dark border"><%= week.startLabel %> â€“ <%= week.endLabel %></span></td>
                <% students.forEach(student => { %>
                  <td class="text-center">
                    <% const status = week.submissions[student._id]; %>
                    <% if (status && status.submitted) { %>
                      <div>
                        <% if (status.status === 'approved') { %>
                          <span class="text-success"><i class="fas fa-check-circle fa-lg"></i></span>
                          <small class="d-block text-success mt-1">Approved</small>
                        <% } else if (status.status === 'rejected') { %>
                          <span class="text-danger"><i class="fas fa-times-circle fa-lg"></i></span>
                          <small class="d-block text-danger mt-1">Rejected</small>
                        <% } else { %>
                          <span class="text-warning"><i class="fas fa-clock fa-lg"></i></span>
                          <small class="d-block text-warning mt-1">Pending</small>
                        <% } %>
                        <small class="d-block text-muted mt-1">
                          <%= new Date(status.submittedAt).toLocaleDateString() %>
                        </small>
                      </div>
                    <% } else { %>
                      <div>
                        <span class="text-danger"><i class="fa-solid fa-xmark"></i></span>
                        <small class="d-block text-muted mt-1">No Submission</small>
                        <% if (status && status.canSubmit) { %>
                          <form method="POST" action="/admin/weekly-summary/submit">
                            <input type="hidden" name="studentId" value="<%= student._id %>" />
                            <input type="hidden" name="weekNumber" value="<%= week.weekNumber %>" />
                            <button type="submit" class="btn btn-sm btn-success mt-2" <%= status.submitDisabled ? 'disabled' : '' %>>
                              <i class="fa-solid fa-upload"></i> Submit
                            </button>
                          </form>
                        <% } %>
                      </div>
                    <% } %>
                  </td>
                <% }) %>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  <% } %>
</div>

<script>
// AJAX for Start Weekly Loop
const startForm = document.getElementById('start-weekly-loop-form');
if (startForm) {
  startForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(startForm);
    const btn = startForm.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Starting...';
    try {
      const res = await fetch(startForm.action, {
        method: 'POST',
        headers: { 'Accept': 'application/json' },
        body: formData
      });
      if (res.ok) {
        // Fade out the form
        startForm.classList.add('fade-out');
        setTimeout(() => {
          startForm.style.display = 'none';
          // Remove any previous alert
          const prevAlert = document.querySelector('.alert.alert-success');
          if (prevAlert) prevAlert.remove();
          // Insert the new alert
          const alert = document.createElement('div');
          alert.className = 'alert alert-success d-flex align-items-center justify-content-center mb-4';
          alert.role = 'alert';
          alert.innerHTML = '<i class="fa-solid fa-circle-check me-2"></i><strong>Weekly Loop is ACTIVE.</strong> Students can submit their weekly reports as scheduled.';
          const cardBody = document.querySelector('.card-body');
          cardBody.insertBefore(alert, cardBody.firstChild);
          // Insert Stop Loop button with animation
          const stopDiv = document.createElement('div');
          stopDiv.className = 'd-flex justify-content-center stop-loop-animated mt-3';
          stopDiv.innerHTML = `<form method="POST" action="/admin/weekly-summary/stop">
            <button type="submit" class="btn btn-danger w-100">
              <i class="fa-solid fa-stop"></i> Stop Loop
            </button>
          </form>`;
          cardBody.appendChild(stopDiv);
        }, 400);
      } else {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-play"></i> Start Weekly Loop';
        alert('Failed to start weekly loop.');
      }
    } catch (err) {
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-play"></i> Start Weekly Loop';
      alert('Error: ' + err.message);
    }
  });
}
</script>