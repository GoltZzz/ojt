<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/weeklyReportsShow.css" />
<link rel="stylesheet" href="/css/reportModals.css" />
<link rel="stylesheet" href="/css/customModal.css" />
<link rel="stylesheet" href="/css/reportButtons.css" />

<div class="container mt-4">
	<div class="report-header mb-4">
		<h1>Weekly Progress Report</h1>
		<div class="report-status">
			<% if (WeeklyProgressReport.status === 'pending') { %>
			<span class="badge bg-warning text-dark">Pending Review</span>
			<% } else if (WeeklyProgressReport.status === 'approved') { %>
			<span class="badge bg-success">Approved</span>
			<% } else { %>
			<span class="badge bg-danger">Rejected</span>
			<% } %> <% if (WeeklyProgressReport.archived) { %>
			<span class="badge bg-secondary ms-2">Archived</span>
			<% } %>
		</div>

		<div class="report-meta">
			<div class="report-info">
				<span class="label">Student:</span>
				<span class="value"><%= WeeklyProgressReport.studentName %></span>
			</div>
			<div class="report-info">
				<span class="label">Internship Site:</span>
				<span class="value"><%= WeeklyProgressReport.internshipSite %></span>
			</div>
			<div class="report-info">
				<span class="label">Week Number:</span>
				<span class="value"><%= WeeklyProgressReport.weekNumber %></span>
			</div>
			<div class="report-info">
				<span class="label">Period:</span>
				<span class="value">
					<%= new Date(WeeklyProgressReport.weekStartDate).toLocaleDateString()
					%> - <%= new
					Date(WeeklyProgressReport.weekEndDate).toLocaleDateString() %>
				</span>
			</div>
			<div class="report-info">
				<span class="label">Date Submitted:</span>
				<span class="value"
					><%= new Date(WeeklyProgressReport.dateSubmitted).toLocaleDateString()
					%></span
				>
			</div>
		</div>
	</div>

	<!-- Weekly Activities Section -->
	<div class="card mb-4">
		<div class="card-header">
			<h5>Weekly Activities</h5>
		</div>
		<div class="card-body">
			<div class="mb-4">
				<h6>Duties Performed this week</h6>
				<p class="mb-0"><%= WeeklyProgressReport.dutiesPerformed %></p>
			</div>
			<div>
				<h6>New Trainings</h6>
				<p class="mb-0"><%= WeeklyProgressReport.newTrainings %></p>
			</div>
		</div>
	</div>

	<!-- Accomplishments Section -->
	<div class="card mb-4">
		<div class="card-header">
			<h5>Major Accomplishments</h5>
		</div>
		<div class="card-body">
			<% if (WeeklyProgressReport.accomplishments &&
			WeeklyProgressReport.accomplishments.length > 0) { %> <%
			WeeklyProgressReport.accomplishments.forEach((accomplishment, index) => {
			%>
			<div
				class="accomplishment-item mb-4 <%= index < WeeklyProgressReport.accomplishments.length - 1 ? 'border-bottom pb-4' : '' %>">
				<div class="mb-3">
					<h6>PROPOSED ACTIVITY</h6>
					<p class="mb-0"><%= accomplishment.proposedActivity %></p>
				</div>
				<div>
					<h6>ACCOMPLISHMENTS</h6>
					<p class="mb-0"><%= accomplishment.accomplishmentDetails %></p>
				</div>
			</div>
			<% }); %> <% } else { %>
			<p class="text-muted">No accomplishments recorded.</p>
			<% } %>
		</div>
	</div>

	<!-- Problems and Goals Section -->
	<div class="card mb-4">
		<div class="card-header">
			<h5>Problems and Goals</h5>
		</div>
		<div class="card-body">
			<div class="mb-4">
				<h6>Problems Encountered</h6>
				<p class="mb-0">
					<%= WeeklyProgressReport.problemsEncountered || 'None reported' %>
				</p>
			</div>
			<div class="mb-4">
				<h6>Solutions Applied</h6>
				<p class="mb-0">
					<%= WeeklyProgressReport.problemSolutions || 'None reported' %>
				</p>
			</div>
			<div>
				<h6>Goals for Next Week</h6>
				<p class="mb-0"><%= WeeklyProgressReport.goalsForNextWeek %></p>
			</div>
		</div>
	</div>

	<!-- Supervisor Section -->
	<div class="card mb-4">
		<div class="card-header">
			<h5>Supervisor Information</h5>
		</div>
		<div class="card-body">
			<div class="supervisor-section">
				<p class="text-center mb-4">Noted by:</p>
				<div class="signature-line text-center">
					<% if (WeeklyProgressReport.supervisorSignature) { %>
					<img
						src="<%= WeeklyProgressReport.supervisorSignature %>"
						alt="Supervisor Signature"
						class="signature-image" />
					<% } else { %>
					<div class="signature-placeholder">________________</div>
					<% } %>
					<p class="supervisor-name mb-0">
						<%= WeeklyProgressReport.supervisorName %>
					</p>
					<p class="supervisor-role">
						<%= WeeklyProgressReport.supervisorRole %>
					</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Action Buttons -->
	<div class="action-buttons">
		<div class="button-group">
			<!-- Edit button - for authors of pending or rejected reports -->
			<% if (WeeklyProgressReport.isAuthor && (WeeklyProgressReport.status ===
			'pending' || WeeklyProgressReport.status === 'rejected') &&
			!WeeklyProgressReport.archived) { %>
			<a
				href="/weeklyprogress/<%= WeeklyProgressReport._id %>/edit"
				class="btn btn-warning">
				<i class="fas fa-edit"></i> Edit
			</a>
			<% } %>

			<!-- Export to PDF button - only for report authors and non-rejected reports -->
			<% if (WeeklyProgressReport.isAuthor && WeeklyProgressReport.status !==
			'rejected') { %>
			<a
				href="/weeklyprogress/<%= WeeklyProgressReport._id %>/export-pdf"
				class="btn btn-primary">
				<i class="fas fa-file-pdf"></i> Export to PDF
			</a>
			<% } %>
		</div>

		<div class="button-group">
			<!-- Admin approval buttons - only for admins with pending reports -->
			<% if (currentUser && currentUser.role === 'admin' &&
			WeeklyProgressReport.status === 'pending') { %>
			<button
				type="button"
				class="btn btn-success"
				data-custom-modal-target="approveModal">
				<i class="fas fa-check"></i> Approve
			</button>
			<button
				type="button"
				class="btn btn-danger"
				data-custom-modal-target="rejectModal">
				<i class="fas fa-times"></i> Reject
			</button>
			<% } %>

			<!-- Archive button - only for admins with non-archived reports -->
			<% if (currentUser && currentUser.role === 'admin' &&
			!WeeklyProgressReport.archived) { %>
			<button
				type="button"
				class="btn btn-secondary"
				data-custom-modal-target="archiveReportModal">
				<i class="fas fa-archive"></i> Archive
			</button>
			<% } %>

			<!-- Unarchive button - only for admins with archived reports -->
			<% if (currentUser && currentUser.role === 'admin' &&
			WeeklyProgressReport.archived) { %>
			<button
				type="button"
				class="btn btn-success"
				data-custom-modal-target="unarchiveReportModal">
				<i class="fas fa-box-open"></i> Unarchive
			</button>
			<% } %>

			<!-- Delete button - only for admins when report is archived -->
			<% if (currentUser && currentUser.role === 'admin' &&
			WeeklyProgressReport.archived) { %>
			<button
				type="button"
				class="btn btn-danger"
				data-custom-modal-target="adminDeleteModal">
				<i class="fas fa-trash"></i> Delete
			</button>
			<% } %>
		</div>
	</div>
</div>

<!-- Archive Report Modal -->
<div
	class="custom-modal-overlay report-modal"
	id="archiveReportModal"
	role="dialog"
	aria-labelledby="archiveReportModalLabel">
	<div class="custom-modal">
		<div class="custom-modal-header bg-secondary">
			<h5 class="custom-modal-title" id="archiveReportModalLabel">
				<i class="fas fa-archive"></i>
				Archive Report
			</h5>
			<button type="button" class="custom-modal-close" aria-label="Close">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div class="custom-modal-body">
			<div class="custom-modal-content">
				<i class="fas fa-file-archive custom-modal-icon text-secondary"></i>
				<h4>Are you sure you want to archive this report?</h4>
				<p class="text-muted mb-4">
					This action will move the report to the archive section.
				</p>

				<div class="form-group">
					<label for="archiveReason" class="form-label">
						<strong>Reason for archiving (optional):</strong>
					</label>
					<textarea
						class="form-control"
						id="archiveReason"
						name="archivedReason"
						rows="3"
						placeholder="Enter a reason for archiving this report"></textarea>
				</div>
			</div>
		</div>
		<div class="custom-modal-footer">
			<form
				id="archiveForm"
				action="/weeklyprogress/<%= WeeklyProgressReport._id %>/archive"
				method="POST"
				data-custom-message="Report has been archived successfully"
				data-action-type="archive"
				class="d-inline">
				<!-- Hidden textarea to store the archive reason -->
				<input
					type="hidden"
					id="hiddenArchiveReason"
					name="archivedReason"
					value="" />
				<button
					type="submit"
					class="custom-modal-btn custom-modal-btn-secondary">
					<i class="fas fa-archive me-1"></i> Archive Report
				</button>
			</form>
		</div>
	</div>
</div>

<!-- Unarchive Report Modal -->
<div
	class="custom-modal-overlay report-modal"
	id="unarchiveReportModal"
	role="dialog"
	aria-labelledby="unarchiveReportModalLabel">
	<div class="custom-modal">
		<div class="custom-modal-header unarchive-header">
			<h5 class="custom-modal-title" id="unarchiveReportModalLabel">
				<i class="fas fa-box-open"></i>
				Unarchive Report
			</h5>
			<button type="button" class="custom-modal-close" aria-label="Close">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div class="custom-modal-body">
			<div class="custom-modal-content">
				<i class="fas fa-box-open custom-modal-icon text-success"></i>
				<h4>Unarchive this report?</h4>
				<p class="text-muted mb-4">
					This action will restore the report from the archive section.
				</p>

				<div class="custom-modal-footer">
					<form
						action="/weeklyprogress/<%= WeeklyProgressReport._id %>/unarchive"
						method="POST"
						data-custom-message="Report has been unarchived successfully"
						data-action-type="unarchive"
						class="d-inline unarchive-form">
						<button
							type="submit"
							class="custom-modal-btn custom-modal-btn-success">
							<i class="fas fa-box-open me-1"></i> Unarchive Report
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Password Confirmation Modal -->
<div
	class="custom-modal-overlay report-modal"
	id="passwordConfirmModal"
	role="dialog"
	aria-labelledby="passwordConfirmModalLabel">
	<div class="custom-modal">
		<div class="custom-modal-header delete-header">
			<h5 class="custom-modal-title" id="passwordConfirmModalLabel">
				<i class="fas fa-lock"></i>
				Confirm Password
			</h5>
			<button type="button" class="custom-modal-close" aria-label="Close">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div class="custom-modal-body">
			<div class="custom-modal-content">
				<i
					class="fas fa-exclamation-triangle custom-modal-icon text-danger"></i>
				<h4>Please confirm your password to delete this report</h4>
				<p class="text-danger mt-3">
					<strong>This action cannot be undone.</strong>
				</p>

				<div class="form-group mt-3">
					<label for="confirmPassword" class="form-label">
						Your Password:
					</label>
					<input
						type="password"
						class="form-control"
						id="confirmPassword"
						name="password"
						required
						placeholder="Enter your password to confirm" />
					<div class="invalid-feedback">Please enter your password.</div>
				</div>

				<div class="custom-modal-footer">
					<form
						id="passwordConfirmForm"
						action="/weeklyprogress/<%= WeeklyProgressReport._id %>?_method=DELETE"
						method="POST"
						class="d-inline">
						<!-- Hidden input to store the password -->
						<input type="hidden" id="hiddenPassword" name="password" value="" />
						<button
							type="submit"
							class="custom-modal-btn custom-modal-btn-danger">
							<i class="fas fa-trash me-1"></i> Delete Report
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Admin Delete Modal (no password required) -->
<div
	class="custom-modal-overlay report-modal"
	id="adminDeleteModal"
	role="dialog"
	aria-labelledby="adminDeleteModalLabel">
	<div class="custom-modal">
		<div class="custom-modal-header delete-header">
			<h5 class="custom-modal-title" id="adminDeleteModalLabel">
				<i class="fas fa-trash"></i>
				Delete Report
			</h5>
			<button type="button" class="custom-modal-close" aria-label="Close">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div class="custom-modal-body">
			<div class="custom-modal-content">
				<i
					class="fas fa-exclamation-triangle custom-modal-icon text-danger"></i>
				<h4>Delete this report?</h4>
				<p class="text-danger mt-3">
					<strong>This action cannot be undone.</strong>
				</p>

				<div class="custom-modal-footer">
					<form
						action="/weeklyprogress/<%= WeeklyProgressReport._id %>?_method=DELETE"
						method="POST"
						data-custom-message="Report has been deleted successfully"
						data-action-type="delete"
						class="d-inline delete-form">
						<!-- Admin doesn't need to enter password -->
						<input type="hidden" name="password" value="admin-bypass" />
						<button
							type="submit"
							class="custom-modal-btn custom-modal-btn-danger">
							<i class="fas fa-trash me-1"></i> Delete Report
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Approve Modal -->
<% if (currentUser && currentUser.role === 'admin' &&
WeeklyProgressReport.status === 'pending') { %>
<div
	class="custom-modal-overlay report-modal"
	id="approveModal"
	role="dialog"
	aria-labelledby="approveModalLabel">
	<div class="custom-modal">
		<div class="custom-modal-header approve-header">
			<h5 class="custom-modal-title" id="approveModalLabel">
				<i class="fas fa-check"></i>
				Approve Report
			</h5>
			<button type="button" class="custom-modal-close" aria-label="Close">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div class="custom-modal-body">
			<div class="custom-modal-content">
				<i class="fas fa-check-circle custom-modal-icon text-success"></i>
				<h4>Approve this report?</h4>
				<p class="text-muted mb-4">
					This action will mark the report as approved and notify the student.
				</p>

				<form
					action="/admin/reports/weeklyprogress/<%= WeeklyProgressReport._id %>/approve"
					method="POST"
					data-custom-message="Report has been approved successfully"
					data-action-type="approve"
					id="approveForm">
					<input type="hidden" name="status" value="approved" />
					<div class="form-group">
						<label for="approveComments" class="form-label">
							Comments (Optional):
						</label>
						<textarea
							class="form-control"
							id="approveComments"
							name="adminComments"
							rows="4"
							placeholder="Add any feedback or comments about this report"
							maxlength="500"></textarea>
						<span class="char-counter" id="approveCharCounter"
							>0/500 characters</span
						>
					</div>

					<div class="custom-modal-footer">
						<button
							type="submit"
							class="custom-modal-btn custom-modal-btn-success">
							<i class="fas fa-check me-2"></i> Approve Report
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<% } %>

<!-- Reject Modal -->
<% if (currentUser && currentUser.role === 'admin' &&
WeeklyProgressReport.status === 'pending') { %>
<div
	class="custom-modal-overlay report-modal"
	id="rejectModal"
	role="dialog"
	aria-labelledby="rejectModalLabel">
	<div class="custom-modal">
		<div class="custom-modal-header reject-header">
			<h5 class="custom-modal-title" id="rejectModalLabel">
				<i class="fas fa-times"></i>
				Reject Report
			</h5>
			<button type="button" class="custom-modal-close" aria-label="Close">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div class="custom-modal-body">
			<div class="custom-modal-content">
				<i class="fas fa-times-circle custom-modal-icon text-danger"></i>
				<h4>Reject this report?</h4>
				<p class="text-muted mb-4">
					This action will mark the report as rejected and notify the student.
				</p>

				<form
					action="/admin/reports/weeklyprogress/<%= WeeklyProgressReport._id %>/reject"
					method="POST"
					data-custom-message="Report has been rejected"
					data-action-type="reject"
					id="rejectForm">
					<input type="hidden" name="status" value="rejected" />
					<div class="form-group">
						<label for="rejectComments" class="form-label required-field">
							Reason for Rejection
						</label>
						<textarea
							class="form-control"
							id="rejectComments"
							name="adminComments"
							rows="4"
							placeholder="Please provide a detailed explanation of why this report is being rejected"
							required
							maxlength="500"></textarea>
						<span class="char-counter" id="rejectCharCounter"
							>0/500 characters</span
						>
					</div>

					<div class="custom-modal-footer">
						<button
							type="submit"
							class="custom-modal-btn custom-modal-btn-danger">
							<i class="fas fa-times me-2"></i> Reject Report
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<% } %>

<!-- Custom modal script is loaded in boilerplate.ejs -->
<script src="/js/reportModals.js"></script>
<script>
	document.addEventListener("DOMContentLoaded", function () {
		// For archive modal
		const archiveReasonTextarea = document.getElementById("archiveReason");
		const hiddenArchiveReason = document.getElementById("hiddenArchiveReason");
		const archiveForm = document.getElementById("archiveForm");

		if (archiveForm && archiveReasonTextarea && hiddenArchiveReason) {
			archiveForm.addEventListener("submit", function () {
				hiddenArchiveReason.value = archiveReasonTextarea.value;
			});
		}

		// For password confirmation modal
		const passwordInput = document.getElementById("confirmPassword");
		const hiddenPassword = document.getElementById("hiddenPassword");
		const passwordForm = document.getElementById("passwordConfirmForm");

		if (passwordForm && passwordInput && hiddenPassword) {
			passwordForm.addEventListener("submit", function () {
				hiddenPassword.value = passwordInput.value;
			});
		}

		// Character counters for approval/rejection forms
		const approveTextarea = document.getElementById("approveComments");
		const approveCounter = document.getElementById("approveCharCounter");
		const rejectTextarea = document.getElementById("rejectComments");
		const rejectCounter = document.getElementById("rejectCharCounter");

		// Setup character counters if elements exist
		if (approveTextarea && approveCounter) {
			approveTextarea.addEventListener("input", function () {
				const currentLength = this.value.length;
				approveCounter.textContent = `${currentLength}/500 characters`;
			});
		}

		if (rejectTextarea && rejectCounter) {
			rejectTextarea.addEventListener("input", function () {
				const currentLength = this.value.length;
				rejectCounter.textContent = `${currentLength}/500 characters`;
			});
		}
	});
</script>
