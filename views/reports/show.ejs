<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/weeklyReportsShow.css" />
<link rel="stylesheet" href="/css/reportModals.css" />
<link rel="stylesheet" href="/css/customModal.css" />
<link rel="stylesheet" href="/css/reportButtons.css" />
<div class="container mt-4">
    <div class="report-header mb-4">
        <h1>Weekly Report Details</h1>
        <div class="report-status">
            <% if (WeeklyReports.status === 'pending') { %>
                <span class="badge bg-warning text-dark">Pending Review</span>
            <% } else if (WeeklyReports.status === 'approved') { %>
                <span class="badge bg-success">Approved</span>
            <% } else { %>
                <span class="badge bg-danger">Rejected</span>
            <% } %>
            <% if (WeeklyReports.archived) { %>
                <span class="badge bg-secondary ms-2">Archived</span>
            <% } %>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <!-- Basic Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Report Information</h5>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Student:</span>
                            <span class="value"><%= WeeklyReports.studentName %></span>
                        </div>
                        <div class="info-item">
                            <span class="label">Internship Site:</span>
                            <span class="value"><%= WeeklyReports.internshipSite %></span>
                        </div>
                        <div class="info-item">
                            <span class="label">Week Number:</span>
                            <span class="value">Week <%= WeeklyReports.weekNumber %></span>
                        </div>
                        <div class="info-item">
                            <span class="label">Period:</span>
                            <span class="value">
                                <%= WeeklyReports.weekStartDate %> - <%= WeeklyReports.weekEndDate %>
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="label">Date Submitted:</span>
                            <span class="value">
                                <%= new Date(WeeklyReports.dateSubmitted).toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric' 
                                }) %>
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="label">Supervisor:</span>
                            <span class="value"><%= WeeklyReports.supervisorName %></span>
                        </div>
                        <% if (WeeklyReports.archived && WeeklyReports.archivedReason) { %>
                            <div class="info-item archived-reason">
                                <span class="label">Archive Reason:</span>
                                <span class="value"><%= WeeklyReports.archivedReason %></span>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

          

            <!-- Files Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Weekly Report Document</h5>
                </div>
                <div class="card-body">
                    <% if (WeeklyReports.pdfFile) { %>
                    <div class="mb-4">
                        <h6>PDF Report</h6>
                        <div class="pdf-viewer mb-3">
                            <iframe 
                                src="<%= WeeklyReports.pdfFile.path %>" 
                                width="100%" 
                                height="600px" 
                                style="border: 1px solid #ddd; border-radius: 4px;"
                                title="Weekly Report PDF">
                            </iframe>
                        </div>
                        <div class="document-download mt-3">
                            <a
                                href="<%= WeeklyReports.pdfFile.path %>"
                                class="btn btn-success"
                                download>
                                <i class="fas fa-download me-2"></i>Download PDF File
                            </a>
                            <small class="text-muted d-block mt-2">
                                File Size: <%= (WeeklyReports.pdfFile.size / 1024 /
                                1024).toFixed(2) %> MB
                            </small>
                        </div>
                    </div>
                    <% } %>
                    
                    <% if (WeeklyReports.docxFile) { %>
                    <div>
                        <h6>Original DOCX File</h6>
                        <div class="document-download">
                            <a
                                href="<%= WeeklyReports.docxFile.path %>"
                                class="btn btn-primary"
                                download>
                                <i class="fas fa-download me-2"></i>Download DOCX File
                            </a>
                            <small class="text-muted d-block mt-2">
                                File Size: <%= (WeeklyReports.docxFile.size / 1024 /
                                1024).toFixed(2) %> MB
                            </small>
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>

       

                    <% if (WeeklyReports.adminComments) { %>
                        <div class="admin-comments mt-3">
                            <strong>Admin Comments:</strong>
                            <p class="mb-0 mt-2"><%= WeeklyReports.adminComments %></p>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-md-8 mx-auto">
                    <div class="action-buttons">
                        <% if (WeeklyReports.canEdit) { %>
                            <a href="/weeklyreport/<%= WeeklyReports._id %>/edit" class="btn btn-warning btn-block mb-2">
                                <i class="fas fa-edit"></i> Edit Report
                            </a>
                        <% } %>

                        <% if (WeeklyReports.canDelete) { %>
                            <button type="button" class="btn btn-danger btn-block mb-2" data-custom-modal-target="deleteReportModal">
                                <i class="fas fa-trash"></i> Delete Report
                            </button>
                        <% } %>

                        <% if (currentUser.role === 'admin') { %>
                            <% if (WeeklyReports.status === 'pending') { %>
                                <button type="button" class="btn btn-success btn-block mb-2" data-custom-modal-target="approveModal">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button type="button" class="btn btn-danger btn-block mb-2" data-custom-modal-target="rejectModal">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            <% } %>
                            
                            <% if (!WeeklyReports.archived) { %>
                                <button type="button" class="btn btn-secondary btn-block mb-2" data-custom-modal-target="archiveReportModal">
                                    <i class="fas fa-archive"></i> Archive
                                </button>
                            <% } else if (WeeklyReports.archived) { %>
                                <button type="button" class="btn btn-warning btn-block mb-2" data-custom-modal-target="unarchiveReportModal">
                                    <i class="fas fa-box-open"></i> Unarchive
                                </button>
                                <button type="button" class="btn btn-danger btn-block mb-2" data-custom-modal-target="adminDeleteModal">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            <% } %>
                        <% } %>
                    </div>
                </div>
            </div>

            <style>
                .action-buttons {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 10px;
                    padding: 20px 0;
                    max-width: 400px;
                    margin: 0 auto;
                }

                .action-buttons .btn {
                    width: 100%;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-weight: 500;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    transition: all 0.3s ease;
                }

                .action-buttons .btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                }

                .action-buttons .btn i {
                    font-size: 1.1rem;
                }

                @media (max-width: 768px) {
                    .action-buttons {
                        padding: 15px;
                        max-width: 100%;
                    }
                }
            </style>
        </div>
    </div>
</div>

<!-- Include all the existing modals -->
<!-- Approve Modal -->
<% if (currentUser.role === 'admin' && WeeklyReports.status === 'pending') { %>
<div
    class="custom-modal-overlay report-modal"
    id="approveModal"
    role="dialog"
    aria-labelledby="approveModalLabel">
    <div class="custom-modal">
        <div class="custom-modal-header approve-header">
            <h5 class="custom-modal-title" id="approveModalLabel">
                <i class="fas fa-check"></i>
                Approve Report
            </h5>
            <button type="button" class="custom-modal-close" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="custom-modal-body">
            <div class="custom-modal-content">
                <i class="fas fa-check-circle custom-modal-icon text-success"></i>
                <h4>Approve this report?</h4>
                <p class="text-muted mb-4">
                    This action will mark the report as approved and notify the
                    student.
                </p>

                <form
                    action="/admin/reports/weeklyreport/<%= WeeklyReports._id %>/approve"
                    method="POST"
                    data-custom-message="Report has been approved successfully"
                    data-action-type="approve"
                    id="approveForm">
                    <input type="hidden" name="status" value="approved" />
                    <div class="form-group">
                        <label for="approveComments" class="form-label">
                            Comments (Optional):
                        </label>
                        <textarea
                            class="form-control"
                            id="approveComments"
                            name="adminComments"
                            rows="4"
                            placeholder="Add any feedback or comments about this report"
                            maxlength="500"></textarea>
                        <span class="char-counter" id="approveCharCounter"
                            >0/500 characters</span
                        >
                    </div>

                    <div class="custom-modal-footer">
                        <button
                            type="submit"
                            class="custom-modal-btn custom-modal-btn-success">
                            <i class="fas fa-check me-2"></i> Approve Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div
    class="custom-modal-overlay report-modal"
    id="rejectModal"
    role="dialog"
    aria-labelledby="rejectModalLabel">
    <div class="custom-modal">
        <div class="custom-modal-header reject-header">
            <h5 class="custom-modal-title" id="rejectModalLabel">
                <i class="fas fa-times"></i>
                Reject Report
            </h5>
            <button type="button" class="custom-modal-close" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="custom-modal-body">
            <div class="custom-modal-content">
                <i class="fas fa-times-circle custom-modal-icon text-danger"></i>
                <h4>Reject this report?</h4>
                <p class="text-muted mb-4">
                    This action will mark the report as rejected and notify the
                    student.
                </p>

                <form
                    action="/admin/reports/weeklyreport/<%= WeeklyReports._id %>/reject"
                    method="POST"
                    data-custom-message="Report has been rejected"
                    data-action-type="reject"
                    id="rejectForm">
                    <input type="hidden" name="status" value="rejected" />
                    <div class="form-group">
                        <label for="rejectComments" class="form-label required-field">
                            Reason for Rejection
                        </label>
                        <textarea
                            class="form-control"
                            id="rejectComments"
                            name="adminComments"
                            rows="4"
                            placeholder="Please provide a detailed explanation of why this report is being rejected"
                            required
                            maxlength="500"></textarea>
                        <span class="char-counter" id="rejectCharCounter"
                            >0/500 characters</span
                        >
                    </div>

                    <div class="custom-modal-footer">
                        <button
                            type="submit"
                            class="custom-modal-btn custom-modal-btn-danger">
                            <i class="fas fa-times me-2"></i> Reject Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<% } %>

<!-- Archive Report Modal -->
<div
    class="custom-modal-overlay"
    id="archiveReportModal"
    role="dialog"
    aria-labelledby="archiveReportModalLabel">
    <div class="custom-modal">
        <div class="custom-modal-header bg-secondary">
            <h5 class="custom-modal-title" id="archiveReportModalLabel">
                <i class="fas fa-archive"></i>
                Archive Report
            </h5>
            <button type="button" class="custom-modal-close" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="custom-modal-body">
            <div class="custom-modal-content">
                <i class="fas fa-file-archive custom-modal-icon text-secondary"></i>
                <h4>Are you sure you want to archive this report?</h4>

                <div class="form-group">
                    <label for="archiveReason" class="form-label">
                        <strong>Reason for archiving (optional):</strong>
                    </label>
                    <textarea
                        class="form-control"
                        id="archiveReason"
                        name="archivedReason"
                        rows="3"
                        placeholder="Enter a reason for archiving this report"></textarea>
                </div>
            </div>
        </div>
        <div class="custom-modal-footer">
            <form
                id="archiveForm"
                action="/weeklyreport/<%= WeeklyReports._id %>/archive"
                method="POST"
                data-custom-message="Report has been archived successfully"
                data-action-type="archive"
                class="d-inline">
                <!-- Hidden textarea to store the archive reason -->
                <input
                    type="hidden"
                    id="hiddenArchiveReason"
                    name="archivedReason"
                    value="" />
                <button
                    type="submit"
                    class="custom-modal-btn custom-modal-btn-secondary">
                    <i class="fas fa-archive me-1"></i> Archive Report
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Unarchive Report Modal -->
<div
    class="custom-modal-overlay"
    id="unarchiveReportModal"
    role="dialog"
    aria-labelledby="unarchiveReportModalLabel">
    <div class="custom-modal">
        <div class="custom-modal-header bg-success">
            <h5 class="custom-modal-title" id="unarchiveReportModalLabel">
                <i class="fas fa-box-open"></i>
                Unarchive Report
            </h5>
            <button type="button" class="custom-modal-close" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="custom-modal-body">
            <div class="custom-modal-content">
                <i class="fas fa-box-open custom-modal-icon text-success"></i>
                <h4>Are you sure you want to unarchive this report?</h4>
            </div>
        </div>
        <div class="custom-modal-footer">
            <form
                action="/admin/reports/weeklyreport/<%= WeeklyReports._id %>/unarchive"
                method="POST"
                data-custom-message="Report has been unarchived successfully"
                data-action-type="unarchive"
                class="d-inline unarchive-form">
                <button
                    type="submit"
                    class="custom-modal-btn custom-modal-btn-success">
                    <i class="fas fa-box-open me-1"></i> Unarchive Report
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Password Confirmation Modal for Delete -->
<% if (WeeklyReports.canDelete) { %>
<div
    class="custom-modal-overlay report-modal"
    id="deleteReportModal"
    role="dialog"
    aria-labelledby="deleteReportModalLabel">
    <div class="custom-modal">
        <div class="custom-modal-header bg-danger">
            <h5 class="custom-modal-title" id="deleteReportModalLabel">
                <i class="fas fa-lock"></i>
                Confirm Password
            </h5>
            <button type="button" class="custom-modal-close" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="custom-modal-body">
            <div class="custom-modal-content">
                <i
                    class="fas fa-exclamation-triangle custom-modal-icon text-danger"></i>
                <h4>Please confirm your password to delete this report</h4>
                <p class="text-danger mt-3">
                    <strong>This action cannot be undone.</strong>
                </p>

                <div class="form-group mt-3">
                    <label for="confirmPassword" class="form-label">
                        <strong>Your Password:</strong>
                    </label>
                    <input
                        type="password"
                        class="form-control"
                        id="confirmPassword"
                        name="password"
                        required
                        placeholder="Enter your password to confirm" />
                    <div class="invalid-feedback">Please enter your password.</div>
                </div>
            </div>
        </div>
        <div class="custom-modal-footer">
            <form
                id="passwordConfirmForm"
                action="/weeklyreport/<%= WeeklyReports._id %>?_method=DELETE"
                method="POST"
                class="d-inline">
                <!-- Hidden input to store the password -->
                <input type="hidden" id="hiddenPassword" name="password" value="" />
                <button
                    type="submit"
                    class="custom-modal-btn custom-modal-btn-danger">
                    <i class="fas fa-trash me-1"></i> Delete Report
                </button>
            </form>
        </div>
    </div>
</div>
<% } %>

<!-- Admin Delete Modal (no password required) -->
<% if (currentUser.role === 'admin' && WeeklyReports.archived) { %>
<div
    class="custom-modal-overlay report-modal"
    id="adminDeleteModal"
    role="dialog"
    aria-labelledby="adminDeleteModalLabel">
    <div class="custom-modal">
        <div class="custom-modal-header bg-danger">
            <h5 class="custom-modal-title" id="adminDeleteModalLabel">
                <i class="fas fa-trash"></i>
                Delete Report
            </h5>
            <button type="button" class="custom-modal-close" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="custom-modal-body">
            <div class="custom-modal-content">
                <i
                    class="fas fa-exclamation-triangle custom-modal-icon text-danger"></i>
                <h4>Are you sure you want to delete this report?</h4>
                <p class="text-danger mt-3">
                    <strong>This action cannot be undone.</strong>
                </p>
            </div>
        </div>
        <div class="custom-modal-footer">
            <form
                action="/weeklyreport/<%= WeeklyReports._id %>?_method=DELETE"
                method="POST"
                data-custom-message="Report has been deleted successfully"
                data-action-type="delete"
                class="d-inline delete-form">
                <!-- Admin doesn't need to enter password -->
                <input type="hidden" name="password" value="admin-bypass" />
                <button
                    type="submit"
                    class="custom-modal-btn custom-modal-btn-danger">
                    <i class="fas fa-trash me-1"></i> Delete Report
                </button>
            </form>
        </div>
    </div>
</div>
<% } %>

<!-- Custom modal scripts -->
<script src="/js/reportModals.js"></script>
<script src="/js/customModal.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // For password confirmation modal
        const passwordInput = document.getElementById("confirmPassword");
        const hiddenPassword = document.getElementById("hiddenPassword");
        const passwordForm = document.getElementById("passwordConfirmForm");

        if (passwordForm && passwordInput && hiddenPassword) {
            passwordForm.addEventListener("submit", function () {
                hiddenPassword.value = passwordInput.value;
            });
        }
    });
</script>
</div>
