<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/weeklyReportsShow.css" />
<link rel="stylesheet" href="/css/reportModals.css" />
<link rel="stylesheet" href="/css/customModal.css" />
<link rel="stylesheet" href="/css/reportButtons.css" />
<div class="container mt-4">
	<div class="report-header mb-4">
		<h1>Weekly Report Details</h1>
		<div class="report-status">
			<% if (WeeklyReports.status) { %> <% if (WeeklyReports.status ===
			'pending') { %>
			<span class="badge bg-warning text-dark">Pending Review</span>
			<% } else if (WeeklyReports.status === 'approved') { %>
			<span class="badge bg-success">Approved</span>
			<% } else { %>
			<span class="badge bg-danger">Rejected</span>
			<% } %> <% } %> <% if (WeeklyReports.archived) { %>
			<span class="badge bg-secondary ms-2">Archived</span>
			<% } %>
		</div>
		<div class="report-meta">
			<div class="report-info">
				<span class="label">Student Name:</span>
				<span class="value"><%= WeeklyReports.studentName %></span>
			</div>
			<div class="report-info">
				<span class="label">Internship Site:</span>
				<span class="value"><%= WeeklyReports.internshipSite %></span>
			</div>
			<div class="report-info">
				<span class="label">Week Period:</span>
				<span class="value"
					><%= WeeklyReports.weekStartDate %> - <%= WeeklyReports.weekEndDate
					%></span
				>
			</div>
			<% if (WeeklyReports.archived && WeeklyReports.archivedReason) { %>
			<div class="report-info">
				<span class="label">Archive Reason:</span>
				<span class="value"><%= WeeklyReports.archivedReason %></span>
			</div>
			<% } %>
		</div>
	</div>

	<div class="daily-records">
		<% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach((day,
		index) => { %>
		<div class="card mb-3">
			<div class="card-header">
				<h5><%= day %></h5>
			</div>
			<div class="card-body">
				<% if (WeeklyReports.dailyRecords && WeeklyReports.dailyRecords[index])
				{ %>
				<div class="time-records">
					<div class="time-block">
						<h6>Morning</h6>
						<div class="time-detail">
							<span
								>In: <%= WeeklyReports.dailyRecords[index].timeIn.morning
								%></span
							>
							<span
								>Out: <%= WeeklyReports.dailyRecords[index].timeOut.morning
								%></span
							>
						</div>
					</div>
					<div class="time-block">
						<h6>Afternoon</h6>
						<div class="time-detail">
							<span
								>In: <%= WeeklyReports.dailyRecords[index].timeIn.afternoon
								%></span
							>
							<span
								>Out: <%= WeeklyReports.dailyRecords[index].timeOut.afternoon
								%></span
							>
						</div>
					</div>
				</div>
				<div class="accomplishments mt-3">
					<h6>Accomplishments:</h6>
					<p><%= WeeklyReports.dailyRecords[index].accomplishments %></p>
				</div>
				<% } else { %>
				<p class="text-muted">No records for this day</p>
				<% } %>
			</div>
		</div>
		<% }) %>
	</div>

	<div class="certification-section">
		<p class="certification-text">
			"I CERTIFY on my honor that the above is a true and correct report of the
			hours of work performed, record of which was made daily at the time of
			arrival at and departure from office."
		</p>

		<div class="signatures">
			<div class="signature-block">
				<div class="signature-line"></div>
				<p class="signature-name"><%= WeeklyReports.supervisorName %></p>
				<p class="signature-title">Company Supervisor's Signature</p>
				<p class="signature-date">
					Date: <%= new Date().toLocaleDateString() %>
				</p>
			</div>

			<div class="signature-block">
				<div class="signature-line"></div>
				<p class="signature-name"><%= WeeklyReports.studentName %></p>
				<p class="signature-title">Student Intern's Signature</p>
				<p class="signature-date">
					Date: <%= new Date().toLocaleDateString() %>
				</p>
			</div>
		</div>
	</div>

	<% if (WeeklyReports.adminComments) { %>
	<div class="admin-comments mt-4 mb-4">
		<h4>Admin Comments</h4>
		<div class="comment-box p-3 border rounded">
			<p><%= WeeklyReports.adminComments %></p>
		</div>
	</div>
	<% } %>

	<div class="action-buttons">
		<div class="button-group">
			<!-- Edit button - only for authors of pending reports -->
			<% if (WeeklyReports.canEdit) { %>
			<a
				href="/weeklyreport/<%= WeeklyReports._id %>/edit"
				class="btn btn-warning">
				<i class="fas fa-edit"></i> Edit Report
			</a>
			<% } %>

			<!-- Export to PDF button - only for report authors and approved reports -->
			<% if (WeeklyReports.isAuthor && WeeklyReports.status === 'approved') { %>
			<a
				href="/weeklyreport/<%= WeeklyReports._id %>/export-pdf"
				class="btn btn-primary">
				<i class="fas fa-file-pdf"></i> Export to PDF
			</a>
			<% } %>

			<!-- Delete button - for authors of pending or rejected reports -->
			<% if (WeeklyReports.canDelete) { %>
			<button
				type="button"
				class="btn btn-danger"
				data-custom-modal-target="deleteReportModal">
				<i class="fas fa-trash"></i> Delete
			</button>
			<% } %>
		</div>

		<div class="button-group">
			<!-- Admin approval buttons - only for admins with pending reports -->
			<% if (currentUser.role === 'admin' && WeeklyReports.status === 'pending')
			{ %>
			<button
				type="button"
				class="btn btn-success"
				data-custom-modal-target="approveModal">
				<i class="fas fa-check"></i> Approve
			</button>
			<button
				type="button"
				class="btn btn-danger"
				data-custom-modal-target="rejectModal">
				<i class="fas fa-times"></i> Reject
			</button>
			<% } %>

			<!-- Archive/Unarchive buttons - only for admins -->
			<% if (currentUser.role === 'admin') { %> <% if (WeeklyReports.archived) {
			%>
			<button
				type="button"
				class="btn btn-success"
				data-custom-modal-target="unarchiveReportModal">
				<i class="fas fa-box-open"></i> Unarchive
			</button>
			<% } else { %>
			<button
				type="button"
				class="btn btn-secondary"
				data-custom-modal-target="archiveReportModal">
				<i class="fas fa-archive"></i> Archive
			</button>
			<% } %> <% } %>
		</div>
	</div>

	<!-- Approve Modal -->
	<% if (currentUser.role === 'admin' && WeeklyReports.status === 'pending') {
	%>
	<div
		class="custom-modal-overlay report-modal"
		id="approveModal"
		role="dialog"
		aria-labelledby="approveModalLabel">
		<div class="custom-modal">
			<div class="custom-modal-header approve-header">
				<h5 class="custom-modal-title" id="approveModalLabel">
					<i class="fas fa-check"></i>
					Approve Report
				</h5>
				<button type="button" class="custom-modal-close" aria-label="Close">
					<i class="fas fa-times"></i>
				</button>
			</div>
			<div class="custom-modal-body">
				<div class="custom-modal-content">
					<i class="fas fa-check-circle custom-modal-icon text-success"></i>
					<h4>Approve this report?</h4>
					<p class="text-muted mb-4">
						This action will mark the report as approved and notify the student.
					</p>

					<form
						action="/admin/reports/<%= WeeklyReports._id %>/approve"
						method="POST"
						data-custom-message="Report has been approved successfully"
						data-action-type="approve"
						id="approveForm">
						<input type="hidden" name="status" value="approved" />
						<div class="form-group">
							<label for="approveComments" class="form-label">
								Comments (Optional):
							</label>
							<textarea
								class="form-control"
								id="approveComments"
								name="adminComments"
								rows="4"
								placeholder="Add any feedback or comments about this report"
								maxlength="500"></textarea>
							<span class="char-counter" id="approveCharCounter"
								>0/500 characters</span
							>
						</div>

						<div class="custom-modal-footer">
							<button
								type="submit"
								class="custom-modal-btn custom-modal-btn-success">
								<i class="fas fa-check me-2"></i> Approve Report
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- Reject Modal -->
	<div
		class="custom-modal-overlay report-modal"
		id="rejectModal"
		role="dialog"
		aria-labelledby="rejectModalLabel">
		<div class="custom-modal">
			<div class="custom-modal-header reject-header">
				<h5 class="custom-modal-title" id="rejectModalLabel">
					<i class="fas fa-times"></i>
					Reject Report
				</h5>
				<button type="button" class="custom-modal-close" aria-label="Close">
					<i class="fas fa-times"></i>
				</button>
			</div>
			<div class="custom-modal-body">
				<div class="custom-modal-content">
					<i class="fas fa-times-circle custom-modal-icon text-danger"></i>
					<h4>Reject this report?</h4>
					<p class="text-muted mb-4">
						This action will mark the report as rejected and notify the student.
					</p>

					<form
						action="/admin/reports/<%= WeeklyReports._id %>/approve"
						method="POST"
						data-custom-message="Report has been rejected"
						data-action-type="reject"
						id="rejectForm">
						<input type="hidden" name="status" value="rejected" />
						<div class="form-group">
							<label for="rejectComments" class="form-label required-field">
								Reason for Rejection
							</label>
							<textarea
								class="form-control"
								id="rejectComments"
								name="adminComments"
								rows="4"
								placeholder="Please provide a detailed explanation of why this report is being rejected"
								required
								maxlength="500"></textarea>
							<span class="char-counter" id="rejectCharCounter"
								>0/500 characters</span
							>
						</div>

						<div class="custom-modal-footer">
							<button
								type="submit"
								class="custom-modal-btn custom-modal-btn-danger">
								<i class="fas fa-times me-2"></i> Reject Report
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
	<% } %>
</div>

<!-- Archive Report Modal -->
<div
	class="custom-modal-overlay"
	id="archiveReportModal"
	role="dialog"
	aria-labelledby="archiveReportModalLabel">
	<div class="custom-modal">
		<div class="custom-modal-header bg-secondary">
			<h5 class="custom-modal-title" id="archiveReportModalLabel">
				<i class="fas fa-archive"></i>
				Archive Report
			</h5>
			<button type="button" class="custom-modal-close" aria-label="Close">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div class="custom-modal-body">
			<div class="custom-modal-content">
				<i class="fas fa-file-archive custom-modal-icon text-secondary"></i>
				<h4>Are you sure you want to archive this report?</h4>

				<div class="form-group">
					<label for="archiveReason" class="form-label">
						<strong>Reason for archiving (optional):</strong>
					</label>
					<textarea
						class="form-control"
						id="archiveReason"
						name="archivedReason"
						rows="3"
						placeholder="Enter a reason for archiving this report"></textarea>
				</div>
			</div>
		</div>
		<div class="custom-modal-footer">
			<form
				id="archiveForm"
				action="/weeklyreport/<%= WeeklyReports._id %>/archive"
				method="POST"
				data-custom-message="Report has been archived successfully"
				data-action-type="archive"
				class="d-inline">
				<!-- Hidden textarea to store the archive reason -->
				<input
					type="hidden"
					id="hiddenArchiveReason"
					name="archivedReason"
					value="" />
				<button
					type="submit"
					class="custom-modal-btn custom-modal-btn-secondary">
					<i class="fas fa-archive me-1"></i> Archive Report
				</button>
			</form>
		</div>
	</div>
</div>

<!-- Unarchive Report Modal -->
<div
	class="custom-modal-overlay"
	id="unarchiveReportModal"
	role="dialog"
	aria-labelledby="unarchiveReportModalLabel">
	<div class="custom-modal">
		<div class="custom-modal-header bg-success">
			<h5 class="custom-modal-title" id="unarchiveReportModalLabel">
				<i class="fas fa-box-open"></i>
				Unarchive Report
			</h5>
			<button type="button" class="custom-modal-close" aria-label="Close">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div class="custom-modal-body">
			<div class="custom-modal-content">
				<i class="fas fa-box-open custom-modal-icon text-success"></i>
				<h4>Are you sure you want to unarchive this report?</h4>
			</div>
		</div>
		<div class="custom-modal-footer">
			<form
				action="/admin/reports/<%= WeeklyReports._id %>/unarchive"
				method="POST"
				data-custom-message="Report has been unarchived successfully"
				data-action-type="unarchive"
				class="d-inline unarchive-form">
				<button type="submit" class="custom-modal-btn custom-modal-btn-success">
					<i class="fas fa-box-open me-1"></i> Unarchive Report
				</button>
			</form>
		</div>
	</div>
</div>

<!-- Delete Report Modal -->
<% if (WeeklyReports.canDelete) { %>
<div
	class="custom-modal-overlay report-modal"
	id="deleteReportModal"
	role="dialog"
	aria-labelledby="deleteReportModalLabel">
	<div class="custom-modal">
		<div class="custom-modal-header bg-danger">
			<h5 class="custom-modal-title" id="deleteReportModalLabel">
				<i class="fas fa-trash"></i>
				Delete Report
			</h5>
			<button type="button" class="custom-modal-close" aria-label="Close">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div class="custom-modal-body">
			<div class="custom-modal-content">
				<i
					class="fas fa-exclamation-triangle custom-modal-icon text-danger"></i>
				<h4>Are you sure you want to delete this report?</h4>
				<p class="text-danger mt-3">
					<strong>This action cannot be undone.</strong>
				</p>
			</div>
		</div>
		<div class="custom-modal-footer">
			<form
				action="/weeklyreport/<%= WeeklyReports._id %>?_method=DELETE"
				method="POST"
				data-custom-message="Report has been deleted successfully"
				data-action-type="delete"
				class="d-inline">
				<button type="submit" class="custom-modal-btn custom-modal-btn-danger">
					<i class="fas fa-trash me-1"></i> Delete Report
				</button>
			</form>
		</div>
	</div>
</div>
<% } %>

<!-- Custom modal scripts -->
<script src="/js/reportModals.js"></script>
<script src="/js/customModal.js"></script>
