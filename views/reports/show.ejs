<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/weeklyReportsShow.css" />
<div class="container mt-4">
	<div class="report-header mb-4">
		<h1>Weekly Report Details</h1>
		<div class="report-status">
			<% if (WeeklyReports.status) { %> <% if (WeeklyReports.status ===
			'pending') { %>
			<span class="badge bg-warning text-dark">Pending Review</span>
			<% } else if (WeeklyReports.status === 'approved') { %>
			<span class="badge bg-success">Approved</span>
			<% } else { %>
			<span class="badge bg-danger">Rejected</span>
			<% } %> <% } %> <% if (WeeklyReports.archived) { %>
			<span class="badge bg-secondary ms-2">Archived</span>
			<% } %>
		</div>
		<div class="report-meta">
			<div class="report-info">
				<span class="label">Student Name:</span>
				<span class="value"><%= WeeklyReports.studentName %></span>
			</div>
			<div class="report-info">
				<span class="label">Internship Site:</span>
				<span class="value"><%= WeeklyReports.internshipSite %></span>
			</div>
			<div class="report-info">
				<span class="label">Week Period:</span>
				<span class="value"
					><%= WeeklyReports.weekStartDate %> - <%= WeeklyReports.weekEndDate
					%></span
				>
			</div>
			<% if (WeeklyReports.archived && WeeklyReports.archivedReason) { %>
			<div class="report-info">
				<span class="label">Archive Reason:</span>
				<span class="value"><%= WeeklyReports.archivedReason %></span>
			</div>
			<% } %>
		</div>
	</div>

	<div class="daily-records">
		<% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach((day,
		index) => { %>
		<div class="card mb-3">
			<div class="card-header">
				<h5><%= day %></h5>
			</div>
			<div class="card-body">
				<% if (WeeklyReports.dailyRecords && WeeklyReports.dailyRecords[index])
				{ %>
				<div class="time-records">
					<div class="time-block">
						<h6>Morning</h6>
						<div class="time-detail">
							<span
								>In: <%= WeeklyReports.dailyRecords[index].timeIn.morning
								%></span
							>
							<span
								>Out: <%= WeeklyReports.dailyRecords[index].timeOut.morning
								%></span
							>
						</div>
					</div>
					<div class="time-block">
						<h6>Afternoon</h6>
						<div class="time-detail">
							<span
								>In: <%= WeeklyReports.dailyRecords[index].timeIn.afternoon
								%></span
							>
							<span
								>Out: <%= WeeklyReports.dailyRecords[index].timeOut.afternoon
								%></span
							>
						</div>
					</div>
				</div>
				<div class="accomplishments mt-3">
					<h6>Accomplishments:</h6>
					<p><%= WeeklyReports.dailyRecords[index].accomplishments %></p>
				</div>
				<% } else { %>
				<p class="text-muted">No records for this day</p>
				<% } %>
			</div>
		</div>
		<% }) %>
	</div>

	<div class="certification-section">
		<p class="certification-text">
			"I CERTIFY on my honor that the above is a true and correct report of the
			hours of work performed, record of which was made daily at the time of
			arrival at and departure from office."
		</p>

		<div class="signatures">
			<div class="signature-block">
				<div class="signature-line"></div>
				<p class="signature-name"><%= WeeklyReports.supervisorName %></p>
				<p class="signature-title">Company Supervisor's Signature</p>
				<p class="signature-date">
					Date: <%= new Date().toLocaleDateString() %>
				</p>
			</div>

			<div class="signature-block">
				<div class="signature-line"></div>
				<p class="signature-name"><%= WeeklyReports.studentName %></p>
				<p class="signature-title">Student Intern's Signature</p>
				<p class="signature-date">
					Date: <%= new Date().toLocaleDateString() %>
				</p>
			</div>
		</div>
	</div>

	<% if (WeeklyReports.adminComments) { %>
	<div class="admin-comments mt-4 mb-4">
		<h4>Admin Comments</h4>
		<div class="comment-box p-3 border rounded">
			<p><%= WeeklyReports.adminComments %></p>
		</div>
	</div>
	<% } %>

	<div class="action-buttons mt-4">
		<% if (WeeklyReports.status === 'pending' && currentUser.role !== 'admin') {
		%>
		<a
			href="/weeklyreport/<%= WeeklyReports._id %>/edit"
			class="btn btn-warning">
			<i class="fas fa-edit"></i> Edit Report
		</a>
		<% } %> <% if (currentUser.role !== 'admin' && (currentUser._id.toString()
		=== WeeklyReports.author?.toString() || !WeeklyReports.author)) { %>
		<button onclick="window.print()" class="btn btn-info">
			<i class="fas fa-print"></i> Print Report
		</button>
		<% } %> <% if (currentUser.role === 'admin' && WeeklyReports.status ===
		'pending') { %>
		<button
			type="button"
			class="btn btn-success"
			data-bs-toggle="modal"
			data-bs-target="#approveModal">
			<i class="fas fa-check"></i> Approve
		</button>
		<button
			type="button"
			class="btn btn-danger"
			data-bs-toggle="modal"
			data-bs-target="#rejectModal">
			<i class="fas fa-times"></i> Reject
		</button>
		<% } %> <% if (currentUser.role === 'admin') { %> <% if
		(WeeklyReports.archived) { %>
		<button
			type="button"
			class="btn btn-success"
			data-bs-toggle="modal"
			data-bs-target="#unarchiveReportModal">
			<i class="fas fa-box-open"></i> Unarchive
		</button>
		<% } else { %>
		<button
			type="button"
			class="btn btn-secondary"
			data-bs-toggle="modal"
			data-bs-target="#archiveReportModal">
			<i class="fas fa-archive"></i> Archive
		</button>
		<% } %> <% } %>

		<!-- Delete button - only for regular users with pending reports -->
		<% if (currentUser.role !== 'admin' && WeeklyReports.status === 'pending') {
		%>
		<form
			class="d-inline"
			action="/weeklyreport/<%= WeeklyReports._id %>?_method=DELETE"
			method="POST">
			<button
				type="submit"
				class="btn btn-danger"
				onclick="return confirm('Are you sure you want to delete this report?')">
				<i class="fas fa-trash"></i> Delete
			</button>
		</form>
		<% } %>
	</div>

	<!-- Approve Modal -->
	<% if (currentUser.role === 'admin' && WeeklyReports.status === 'pending') {
	%>
	<div
		class="modal fade"
		id="approveModal"
		tabindex="-1"
		aria-labelledby="approveModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="approveModalLabel">Approve Report</h5>
					<button
						type="button"
						class="btn-close"
						data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<form
					action="/admin/reports/<%= WeeklyReports._id %>/approve"
					method="POST">
					<div class="modal-body">
						<input type="hidden" name="status" value="approved" />
						<div class="mb-3">
							<label for="adminComments" class="form-label"
								>Comments (Optional)</label
							>
							<textarea
								class="form-control"
								id="adminComments"
								name="adminComments"
								rows="3"
								placeholder="Add any comments about this report"></textarea>
						</div>
						<p>Are you sure you want to approve this report?</p>
					</div>
					<div class="modal-footer">
						<button
							type="button"
							class="btn btn-secondary"
							data-bs-dismiss="modal">
							Cancel
						</button>
						<button type="submit" class="btn btn-success">
							Approve Report
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Reject Modal -->
	<div
		class="modal fade"
		id="rejectModal"
		tabindex="-1"
		aria-labelledby="rejectModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="rejectModalLabel">Reject Report</h5>
					<button
						type="button"
						class="btn-close"
						data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<form
					action="/admin/reports/<%= WeeklyReports._id %>/approve"
					method="POST">
					<div class="modal-body">
						<input type="hidden" name="status" value="rejected" />
						<div class="mb-3">
							<label for="adminComments" class="form-label"
								>Reason for Rejection (Required)</label
							>
							<textarea
								class="form-control"
								id="adminComments"
								name="adminComments"
								rows="3"
								placeholder="Explain why this report is being rejected"
								required></textarea>
						</div>
						<p class="text-danger">
							Are you sure you want to reject this report?
						</p>
					</div>
					<div class="modal-footer">
						<button
							type="button"
							class="btn btn-secondary"
							data-bs-dismiss="modal">
							Cancel
						</button>
						<button type="submit" class="btn btn-danger">Reject Report</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<% } %>
</div>

<!-- Archive Report Modal -->
<div
	class="modal fade"
	id="archiveReportModal"
	tabindex="-1"
	aria-labelledby="archiveReportModalLabel"
	aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header bg-secondary text-white">
				<h5 class="modal-title" id="archiveReportModalLabel">
					<i class="fas fa-archive me-2"></i>
					Archive Report
				</h5>
				<button
					type="button"
					class="btn-close btn-close-white"
					data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="text-center mb-4">
					<i class="fas fa-file-archive fa-4x text-secondary mb-3"></i>
					<h4>Are you sure you want to archive this report?</h4>
				</div>

				<div class="alert alert-warning">
					<i class="fas fa-info-circle me-2"></i>
					<strong>Report details:</strong>
					<ul class="mb-0 mt-2">
						<li><strong>Student:</strong> <%= WeeklyReports.studentName %></li>
						<li>
							<strong>Internship Site:</strong> <%= WeeklyReports.internshipSite
							%>
						</li>
						<li>
							<strong>Week Period:</strong> <%= WeeklyReports.weekStartDate %> -
							<%= WeeklyReports.weekEndDate %>
						</li>
						<li>
							<strong>Status:</strong> <%=
							WeeklyReports.status.charAt(0).toUpperCase() +
							WeeklyReports.status.slice(1) %>
						</li>
					</ul>
				</div>

				<div class="alert alert-info">
					<i class="fas fa-lightbulb me-2"></i>
					Archived reports will be moved to the Archive section and will no
					longer appear in the regular reports list. You can access archived
					reports from the "Archived Reports" page in the admin panel.
				</div>

				<div class="form-group">
					<label for="archiveReason" class="form-label"
						><strong>Reason for archiving (optional):</strong></label
					>
					<textarea
						class="form-control"
						id="archiveReason"
						name="archivedReason"
						rows="3"
						placeholder="Enter a reason for archiving this report"></textarea>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-light" data-bs-dismiss="modal">
					<i class="fas fa-times me-1"></i> Cancel
				</button>
				<form
					id="archiveForm"
					action="/weeklyreport/<%= WeeklyReports._id %>/archive"
					method="POST"
					class="d-inline">
					<!-- Hidden textarea to store the archive reason -->
					<input
						type="hidden"
						id="hiddenArchiveReason"
						name="archivedReason"
						value="" />
					<button type="submit" class="btn btn-secondary">
						<i class="fas fa-archive me-1"></i> Archive Report
					</button>
				</form>
			</div>
		</div>
	</div>
</div>

<!-- Unarchive Report Modal -->
<div
	class="modal fade"
	id="unarchiveReportModal"
	tabindex="-1"
	aria-labelledby="unarchiveReportModalLabel"
	aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header bg-success text-white">
				<h5 class="modal-title" id="unarchiveReportModalLabel">
					<i class="fas fa-box-open me-2"></i>
					Unarchive Report
				</h5>
				<button
					type="button"
					class="btn-close btn-close-white"
					data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="text-center mb-4">
					<i class="fas fa-box-open fa-4x text-success mb-3"></i>
					<h4>Are you sure you want to unarchive this report?</h4>
				</div>

				<div class="alert alert-warning">
					<i class="fas fa-info-circle me-2"></i>
					<strong>Report details:</strong>
					<ul class="mb-0 mt-2">
						<li><strong>Student:</strong> <%= WeeklyReports.studentName %></li>
						<li>
							<strong>Internship Site:</strong> <%= WeeklyReports.internshipSite
							%>
						</li>
						<li>
							<strong>Week Period:</strong> <%= WeeklyReports.weekStartDate %> -
							<%= WeeklyReports.weekEndDate %>
						</li>
						<li>
							<strong>Status:</strong> <%=
							WeeklyReports.status.charAt(0).toUpperCase() +
							WeeklyReports.status.slice(1) %>
						</li>
						<li>
							<strong>Archive Reason:</strong> <%= WeeklyReports.archivedReason
							|| 'Not specified' %>
						</li>
					</ul>
				</div>

				<div class="alert alert-info">
					<i class="fas fa-lightbulb me-2"></i>
					Unarchiving this report will make it visible in the regular reports
					list again. The report will maintain its current status (<strong
						><%= WeeklyReports.status %></strong
					>).
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-light" data-bs-dismiss="modal">
					<i class="fas fa-times me-1"></i> Cancel
				</button>
				<form
					action="/admin/reports/<%= WeeklyReports._id %>/unarchive"
					method="POST"
					class="d-inline unarchive-form">
					<button type="submit" class="btn btn-success">
						<i class="fas fa-box-open me-1"></i> Unarchive Report
					</button>
				</form>
			</div>
		</div>
	</div>
</div>

<script src="/js/modalHandlers.js"></script>
