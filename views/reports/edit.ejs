<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/flashMsg.css" />
<link rel="stylesheet" href="/css/sidebar.css" />
<link rel="stylesheet" href="/css/footer.css" />
<link rel="stylesheet" href="/css/breadcrumbs.css" />
<link rel="stylesheet" href="/css/weeklyReportsNew.css" />
<div class="container mt-4">
	<h1 class="mb-4">Edit Weekly Report</h1>
	<form
		action="/weeklyreport/<%= WeeklyReports._id %>/update?_method=PUT"
		method="POST"
		enctype="multipart/form-data"
		class="validated-form needs-validation">
		<div class="card mb-4">
			<div class="card-header">
				<h5>Student Information</h5>
			</div>
			<div class="card-body">
				<div class="mb-3">
					<label for="studentName" class="form-label"
						>Student Name
						<small class="text-muted">(cannot be changed)</small></label
					>
					<div class="input-group">
						<span class="input-group-text"><i class="fas fa-user"></i></span>
						<input
							type="text"
							class="form-control bg-light"
							id="studentName"
							name="studentName"
							value="<%= fullName %>"
							readonly
							required />
						<span
							class="input-group-text"
							data-bs-toggle="tooltip"
							title="This field cannot be changed">
							<i class="fas fa-lock"></i>
						</span>
					</div>
					<small class="form-text text-muted"
						>This field is automatically filled with your full name and cannot
						be changed.</small
					>
				</div>
				<div class="mb-3">
					<label for="internshipSite" class="form-label">Internship Site</label>
					<div class="input-group">
						<span class="input-group-text"
							><i class="fas fa-building"></i
						></span>
						<input
							type="text"
							class="form-control bg-light"
							id="internshipSite"
							name="internshipSite"
							value="<%= WeeklyReports.internshipSite %>"
							readonly />
					</div>
					<small class="form-text text-muted"
						>This field is automatically filled with your internship site and
						cannot be changed.</small
					>
				</div>
				<div class="row">
					<div class="col-md-4 mb-3">
						<label for="weekNumber" class="form-label">Week Number</label>
						<div class="input-group">
							<span class="input-group-text"
								><i class="fas fa-hashtag"></i
							></span>
							<input
								type="number"
								class="form-control"
								id="weekNumber"
								name="weekNumber"
								min="1"
								value="<%= WeeklyReports.weekNumber %>"
								required />
							<div class="invalid-feedback">
								Please provide a valid week number (minimum 1).
							</div>
						</div>
					</div>
					<div class="col-md-4 mb-3">
						<label for="weekStartDate" class="form-label"
							>Week Start Date</label
						>
						<div class="input-group">
							<span class="input-group-text"
								><i class="fas fa-calendar-alt"></i
							></span>
							<input
								type="date"
								class="form-control"
								id="weekStartDate"
								name="weekStartDate"
								value="<%= typeof WeeklyReports.weekStartDate === 'string' ? new Date(WeeklyReports.weekStartDate).toISOString().split('T')[0] : WeeklyReports.weekStartDate.toISOString().split('T')[0] %>"
								required />
							<div class="invalid-feedback">
								Please select a start date for the week.
							</div>
						</div>
					</div>
					<div class="col-md-4 mb-3">
						<label for="weekEndDate" class="form-label">Week End Date</label>
						<div class="input-group">
							<span class="input-group-text"
								><i class="fas fa-calendar-alt"></i
							></span>
							<input
								type="date"
								class="form-control"
								id="weekEndDate"
								name="weekEndDate"
								value="<%= typeof WeeklyReports.weekEndDate === 'string' ? new Date(WeeklyReports.weekEndDate).toISOString().split('T')[0] : WeeklyReports.weekEndDate.toISOString().split('T')[0] %>"
								required />
							<div class="invalid-feedback">
								Please select an end date for the week (must be after start
								date).
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Daily Records -->
		<div id="dailyRecords" novalidate>
			<% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach((day,
			index) => { %>
			<div class="card mb-3">
				<div class="card-header"><%= day %></div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-3">
							<label>Morning Time In</label>
							<input
								type="time"
								class="form-control"
								name="dailyRecords[<%= index %>][timeIn][morning]"
								value="<%= WeeklyReports.dailyRecords && WeeklyReports.dailyRecords[index] && WeeklyReports.dailyRecords[index].timeIn && WeeklyReports.dailyRecords[index].timeIn.morning !== 'N/A' ? WeeklyReports.dailyRecords[index].timeIn.morning : '' %>" />
						</div>
						<div class="col-md-3">
							<label>Morning Time Out</label>
							<input
								type="time"
								class="form-control"
								name="dailyRecords[<%= index %>][timeOut][morning]"
								value="12:00"
								readonly
								style="background-color: #e9ecef" />
						</div>
						<div class="col-md-3">
							<label>Afternoon Time In</label>
							<input
								type="time"
								class="form-control"
								name="dailyRecords[<%= index %>][timeIn][afternoon]"
								value="01:00"
								readonly
								style="background-color: #e9ecef" />
						</div>
						<div class="col-md-3">
							<label>Afternoon Time Out</label>
							<input
								type="time"
								class="form-control"
								name="dailyRecords[<%= index %>][timeOut][afternoon]"
								value="<%= WeeklyReports.dailyRecords && WeeklyReports.dailyRecords[index] && WeeklyReports.dailyRecords[index].timeOut && WeeklyReports.dailyRecords[index].timeOut.afternoon !== 'N/A' ? WeeklyReports.dailyRecords[index].timeOut.afternoon : '' %>" />
						</div>
						<div class="col-12 mt-2">
							<label>Accomplishments</label>
							<textarea
								class="form-control"
								name="dailyRecords[<%= index %>][accomplishments]"
								placeholder="Enter your accomplishments for the day (optional)">
<%= WeeklyReports.dailyRecords && WeeklyReports.dailyRecords[index] && WeeklyReports.dailyRecords[index].accomplishments && WeeklyReports.dailyRecords[index].accomplishments !== 'No accomplishments recorded' ? WeeklyReports.dailyRecords[index].accomplishments : '' %></textarea
							>
						</div>
					</div>
				</div>
			</div>
			<% }) %>
		</div>

		<div class="mb-3">
			<label for="supervisorName" class="form-label">Supervisor Name</label>
			<input
				type="text"
				class="form-control"
				id="supervisorName"
				name="supervisorName"
				value="<%= WeeklyReports.supervisorName %>"
				required />
		</div>

		<div class="card mb-4">
			<div class="card-header">
				<h5>Files</h5>
			</div>
			<div class="card-body">
				<div class="mb-4">
					<label for="docxFile" class="form-label"
						>Weekly Report Document</label
					>
					<% if (WeeklyReports.docxFile) { %>
					<div class="current-file mb-3">
						<p class="mb-2">
							Current file: <%= WeeklyReports.docxFile.filename %>
						</p>
						<a
							href="<%= WeeklyReports.docxFile.path %>"
							class="btn btn-sm btn-primary"
							download>
							<i class="fas fa-download me-2"></i>Download Current File
						</a>
					</div>
					<% } %>
					<div class="input-group">
						<span class="input-group-text"
							><i class="fas fa-file-word"></i
						></span>
						<input
							type="file"
							class="form-control"
							id="docxFile"
							name="docxFile"
							accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
					</div>
					<div class="form-text">
						Upload a new DOCX file to replace the current one (optional). Must
						be less than 10MB.
					</div>
				</div>

				<div class="mb-4">
					<label for="photos" class="form-label">Report Photo</label>
					<% if (WeeklyReports.photos && WeeklyReports.photos.length > 0) { %>
					<div class="current-photo mb-3">
						<p class="mb-2">Current photo:</p>
						<img
							src="<%= WeeklyReports.photos[0].path %>"
							alt="Current Report Photo"
							class="img-thumbnail"
							style="max-width: 200px" />
					</div>
					<% } %>
					<div class="input-group">
						<span class="input-group-text"><i class="fas fa-image"></i></span>
						<input
							type="file"
							class="form-control"
							id="photos"
							name="photos"
							accept=".jpg,.jpeg,.png,image/jpeg,image/png" />
					</div>
					<div class="form-text">
						Upload a new photo to replace the current one (optional). Must be
						less than 10MB.
					</div>
				</div>

				<div id="imagePreview" class="mt-3 d-none">
					<h6>New Image Preview</h6>
					<img
						id="preview"
						src="#"
						alt="Preview"
						style="max-width: 300px; max-height: 300px"
						class="img-thumbnail" />
				</div>
			</div>
		</div>

		<div class="mb-3">
			<p class="text-center font-italic">
				"I CERTIFY on my honor that the above is a true and correct report of
				the hours of work performed, record of which was made daily at the time
				of arrival at and departure from office."
			</p>
		</div>

		<div class="text-center">
			<button type="submit" class="btn btn-primary">Update Report</button>
			<a
				href="/weeklyreport/<%= WeeklyReports._id %>"
				class="btn btn-secondary ms-2"
				>Cancel</a
			>
		</div>
	</form>
</div>

<script>
	// Initialize tooltips
	document.addEventListener("DOMContentLoaded", function () {
		var tooltipTriggerList = [].slice.call(
			document.querySelectorAll('[data-bs-toggle="tooltip"]')
		);
		var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
			return new bootstrap.Tooltip(tooltipTriggerEl);
		});
	});

	document.getElementById("photos").addEventListener("change", function (e) {
		const file = e.target.files[0];
		if (file) {
			const reader = new FileReader();
			reader.onload = function (e) {
				document.getElementById("preview").src = e.target.result;
				document.getElementById("imagePreview").classList.remove("d-none");
			};
			reader.readAsDataURL(file);
		}
	});

	// Add client-side validation for date range
	document.addEventListener("DOMContentLoaded", function () {
		const form = document.querySelector(".validated-form");
		const weekStartDate = document.getElementById("weekStartDate");
		const weekEndDate = document.getElementById("weekEndDate");

		form.addEventListener("submit", function (event) {
			const startDate = new Date(weekStartDate.value);
			const endDate = new Date(weekEndDate.value);

			if (endDate < startDate) {
				event.preventDefault();
				weekEndDate.setCustomValidity(
					"End date must be after or equal to start date"
				);
				weekEndDate.reportValidity();
			} else {
				weekEndDate.setCustomValidity("");
			}
		});

		// Clear validation when dates change
		weekStartDate.addEventListener("change", function () {
			weekEndDate.setCustomValidity("");
		});
		weekEndDate.addEventListener("change", function () {
			weekEndDate.setCustomValidity("");
		});
	});
</script>
