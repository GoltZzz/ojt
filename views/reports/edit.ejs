<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/flashMsg.css" />
<link rel="stylesheet" href="/css/sidebar.css" />
<link rel="stylesheet" href="/css/footer.css" />
<link rel="stylesheet" href="/css/breadcrumbs.css" />
<link rel="stylesheet" href="/css/weeklyReportsNew.css" />
<div class="container mt-4">
	<h1 class="mb-4">Edit Weekly Report</h1>
	<form
		action="/weeklyreport/<%= WeeklyReports._id %>/update"
		method="POST"
		enctype="multipart/form-data"
		class="validated-form needs-validation">
		<input type="hidden" name="_method" value="PATCH" />
		<div class="card mb-4">
			<div class="card-header">
				<h5>Student Information</h5>
			</div>
			<div class="card-body">
				<div class="mb-3">
					<label for="studentName" class="form-label"
						>Student Name
						<small class="text-muted">(cannot be changed)</small></label
					>
					<div class="input-group">
						<span class="input-group-text"><i class="fas fa-user"></i></span>
						<input
							type="text"
							class="form-control bg-light"
							id="studentName"
							name="studentName"
							value="<%= fullName %>"
							readonly
							required />
						<span
							class="input-group-text"
							data-bs-toggle="tooltip"
							title="This field cannot be changed">
							<i class="fas fa-lock"></i>
						</span>
					</div>
					<small class="form-text text-muted"
						>This field is automatically filled with your full name and cannot
						be changed.</small
					>
				</div>
				<div class="mb-3">
					<label for="internshipSite" class="form-label">Internship Site</label>
					<div class="input-group">
						<span class="input-group-text"
							><i class="fas fa-building"></i
						></span>
						<input
							type="text"
							class="form-control bg-light"
							id="internshipSite"
							name="internshipSite"
							value="<%= WeeklyReports.internshipSite %>"
							readonly />
					</div>
					<small class="form-text text-muted"
						>This field is automatically filled with your internship site and
						cannot be changed.</small
					>
				</div>
				<div class="row">
					<div class="col-md-4 mb-3">
						<label for="weekNumber" class="form-label">Week Number</label>
						<div class="input-group">
							<span class="input-group-text"
								><i class="fas fa-hashtag"></i
							></span>
							<input
								type="number"
								class="form-control"
								id="weekNumber"
								name="weekNumber"
								min="1"
								value="<%= WeeklyReports.weekNumber %>"
								required />
							<div class="invalid-feedback">
								Please provide a valid week number (minimum 1).
							</div>
						</div>
					</div>
					<div class="col-md-4 mb-3">
						<label for="weekStartDate" class="form-label"
							>Week Start Date</label
						>
						<div class="input-group">
							<span class="input-group-text"
								><i class="fas fa-calendar-alt"></i
							></span>
							<input
								type="date"
								class="form-control"
								id="weekStartDate"
								name="weekStartDate"
								value="<%= WeeklyReports.weekStartDate ? new Date(WeeklyReports.weekStartDate).toISOString().split('T')[0] : '' %>"
								required />
							<div class="invalid-feedback">
								Please select a start date for the week.
							</div>
						</div>
					</div>
					<div class="col-md-4 mb-3">
						<label for="weekEndDate" class="form-label">Week End Date</label>
						<div class="input-group">
							<span class="input-group-text"
								><i class="fas fa-calendar-alt"></i
							></span>
							<input
								type="date"
								class="form-control"
								id="weekEndDate"
								name="weekEndDate"
								value="<%= WeeklyReports.weekEndDate ? new Date(WeeklyReports.weekEndDate).toISOString().split('T')[0] : '' %>"
								required />
							<div class="invalid-feedback">
								Please select an end date for the week (must be after start
								date).
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="card mb-4">
			<div class="card-header">
				<h5>Supervisor Information</h5>
			</div>
			<div class="card-body">
				<div class="mb-3">
					<label for="supervisorName" class="form-label">Supervisor Name</label>
					<input
						type="text"
						class="form-control"
						id="supervisorName"
						name="supervisorName"
						value="<%= WeeklyReports.supervisorName %>"
						required />
				</div>
			</div>
		</div>

		<div class="card mb-4">
			<div class="card-header">
				<h5>Files</h5>
			</div>
			<div class="card-body">
				<div class="mb-4">
					<label for="docxFile" class="form-label"
						>Weekly Report Document (DOCX)</label
					>
					<% if (WeeklyReports.docxFile) { %>
					<div class="current-file mb-3">
						<p class="mb-2">
							Current file: <%= WeeklyReports.docxFile.filename %>
						</p>
						<a
							href="<%= WeeklyReports.docxFile.path %>"
							class="btn btn-sm btn-primary"
							download>
							<i class="fas fa-download me-2"></i>Download Current DOCX File
						</a>
					</div>
					<% } %> <% if (WeeklyReports.pdfFile) { %>
					<div class="current-file mb-3">
						<p class="mb-2">
							Generated PDF file: <%= WeeklyReports.pdfFile.filename %>
						</p>
						<a
							href="<%= WeeklyReports.pdfFile.path %>"
							class="btn btn-sm btn-success"
							download>
							<i class="fas fa-download me-2"></i>Download PDF File
						</a>
					</div>
					<% } %>

					<div class="input-group">
						<span class="input-group-text"
							><i class="fas fa-file-word"></i
						></span>
						<input
							type="file"
							class="form-control"
							id="docxFile"
							name="docxFile"
							accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
					</div>
					<div class="form-text">
						Upload a new DOCX file to replace the current one (optional). Must
						be less than 10MB. The file will be automatically converted to PDF
						for viewing.
					</div>
				</div>
			</div>
		</div>

		<div class="text-center">
			<button type="submit" class="btn btn-primary">Update Report</button>
			<a
				href="/weeklyreport/<%= WeeklyReports._id %>"
				class="btn btn-secondary ms-2"
				>Cancel</a
			>
		</div>
	</form>
</div>

<script>
	// Initialize tooltips
	document.addEventListener("DOMContentLoaded", function () {
		var tooltipTriggerList = [].slice.call(
			document.querySelectorAll('[data-bs-toggle="tooltip"]')
		);
		var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
			return new bootstrap.Tooltip(tooltipTriggerEl);
		});
	});

	// Stronger client-side validation for weekStartDate and weekEndDate
	function validateDates() {
		const weekStartDate = document.getElementById("weekStartDate");
		const weekEndDate = document.getElementById("weekEndDate");
		const submitBtn = document.querySelector("button[type='submit']");
		let errorMsg = document.getElementById("dateErrorMsg");
		if (!errorMsg) {
			errorMsg = document.createElement("div");
			errorMsg.id = "dateErrorMsg";
			errorMsg.className = "text-danger mb-2";
			weekEndDate.parentNode.appendChild(errorMsg);
		}
		if (weekStartDate.value && weekEndDate.value) {
			const startDate = new Date(weekStartDate.value);
			const endDate = new Date(weekEndDate.value);
			if (endDate < startDate) {
				errorMsg.textContent = "End date must be after or equal to start date.";
				submitBtn.disabled = true;
				weekEndDate.classList.add("is-invalid");
			} else {
				errorMsg.textContent = "";
				submitBtn.disabled = false;
				weekEndDate.classList.remove("is-invalid");
			}
		} else {
			errorMsg.textContent = "";
			submitBtn.disabled = false;
			weekEndDate.classList.remove("is-invalid");
		}
	}
	document.addEventListener("DOMContentLoaded", function () {
		const weekStartDate = document.getElementById("weekStartDate");
		const weekEndDate = document.getElementById("weekEndDate");
		weekStartDate.addEventListener("change", validateDates);
		weekEndDate.addEventListener("change", validateDates);
		validateDates(); // Initial check
	});
</script>
