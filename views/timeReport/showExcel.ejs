<%- layout('layouts/boilerplate') %>

<div class="container mt-4">
	<div class="row mb-4">
		<div class="col-md-8">
			<h2>Time Report Details</h2>
			<% if (timeReport) { %>
			<div class="card mb-3">
				<div class="card-body">
					<div class="row">
						<div class="col-md-6">
							<p><strong>Student:</strong> <%= timeReport.studentName %></p>
							<p>
								<strong>Internship Site:</strong> <%= timeReport.internshipSite
								%>
							</p>
							<p>
								<strong>Date Submitted:</strong> <%= new
								Date(timeReport.dateSubmitted).toLocaleDateString() %>
							</p>
							<% if (timeReport.status) { %>
							<p>
								<strong>Status:</strong>
								<span class="badge bg-success">Approved</span>
							</p>
							<% } %>
						</div>
						<div class="col-md-6">
							<p>
								<strong>Week Period:</strong>
								<%= new Date(timeReport.weekStartDate).toLocaleDateString() %> -
								<%= new Date(timeReport.weekEndDate).toLocaleDateString() %>
							</p>
							<p>
								<strong>Excel File:</strong> <%=
								timeReport.excelFile.originalName %>
							</p>
							<p>
								<strong>Upload Date:</strong> <%= new
								Date(timeReport.excelFile.uploadDate).toLocaleString() %>
							</p>
							<% if (timeReport.summary && timeReport.summary.totalHours) { %>
							<p>
								<strong>Total Hours:</strong> <%= timeReport.summary.totalHours
								%> hours
							</p>
							<% } %>
						</div>
					</div>
					<% if (previewUrl) { %>
					<div class="mt-3">
						<div class="d-flex justify-content-center">
							<img
								src="<%= previewUrl %>"
								alt="Excel Preview"
								class="img-fluid border rounded shadow-sm"
								style="max-height: 200px" />
						</div>
						<p class="text-center text-muted small mt-2">
							Preview of the Excel file
						</p>
					</div>
					<% } %>
				</div>
			</div>
			<% } else { %>
			<div class="alert alert-info">
				No time report data available for this file.
			</div>
			<% } %>
		</div>
		<div class="col-md-4 text-end">
			<div class="d-grid gap-2">
				<a
					href="/uploads/excel/<%= filename %>"
					download
					class="btn btn-primary">
					<i class="fas fa-file-download"></i> Download Excel File
				</a>
				<a href="/timereport" class="btn btn-secondary">
					<i class="fas fa-arrow-left"></i> Back to Time Reports
				</a>
				<% if (timeReport && timeReport.author && timeReport.author.toString()
				=== currentUser._id.toString()) { %>
				<button
					type="button"
					class="btn btn-danger"
					data-bs-toggle="modal"
					data-bs-target="#deleteConfirmModal">
					<i class="fas fa-trash me-1"></i> Delete Report
				</button>
				<% } %>
			</div>
		</div>
	</div>

	<div class="card mb-4">
		<div
			class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
			<h4 class="mb-0">Excel Time Report Viewer</h4>
			<div class="dropdown">
				<button
					class="btn btn-sm btn-light dropdown-toggle"
					type="button"
					id="viewerOptions"
					data-bs-toggle="dropdown"
					aria-expanded="false">
					Viewer Options
				</button>
				<ul
					class="dropdown-menu dropdown-menu-end"
					aria-labelledby="viewerOptions">
					<li>
						<button class="dropdown-item" id="jsViewerBtn" type="button">
							JS Viewer (Recommended)
						</button>
					</li>
					<li>
						<button class="dropdown-item" id="msViewerBtn" type="button">
							Microsoft Viewer
						</button>
					</li>
					<li>
						<button class="dropdown-item" id="msAltViewerBtn" type="button">
							Microsoft Alt Viewer
						</button>
					</li>
					<li>
						<button class="dropdown-item" id="googleViewerBtn" type="button">
							Google Viewer
						</button>
					</li>
					<li>
						<button class="dropdown-item" id="embedViewerBtn" type="button">
							Basic Viewer
						</button>
					</li>
					<li><hr class="dropdown-divider" /></li>
					<li>
						<a class="dropdown-item" href="<%= directFileUrl %>" download
							>Download File</a
						>
					</li>
				</ul>
			</div>
		</div>
		<div class="card-body p-0">
			<div id="jsViewer" style="display: none">
				<div class="p-3">
					<div class="alert alert-info mb-4">
						<i class="fas fa-info-circle me-2"></i>
						This viewer shows a simplified version of the Excel file directly in
						your browser.
					</div>
					<div id="sheetjs-container" class="border rounded p-2 my-3">
						<div id="loading-indicator" class="text-center py-5">
							<div class="spinner-border text-primary" role="status">
								<span class="visually-hidden">Loading...</span>
							</div>
							<p class="mt-3">Loading Excel file...</p>
						</div>
						<div
							id="excel-data"
							class="overflow-auto"
							style="max-height: 500px"></div>
					</div>
				</div>
			</div>
			<div id="msViewer">
				<iframe
					src="<%= msViewerUrl %>"
					width="100%"
					height="600px"
					style="border: none"
					id="msOfficeFrame"></iframe>
			</div>
			<div id="msAltViewer" style="display: none">
				<iframe
					src="<%= msViewerAltUrl %>"
					width="100%"
					height="600px"
					style="border: none"
					id="msAltOfficeFrame"></iframe>
			</div>
			<div id="googleViewer" style="display: none">
				<iframe
					src="<%= googleViewerUrl %>"
					width="100%"
					height="600px"
					style="border: none"
					id="googleFrame"></iframe>
			</div>
			<div id="embedViewer" style="display: none">
				<div class="text-center p-4">
					<p class="mb-4 text-muted">
						Basic preview may not work for all Excel files. If you see an error,
						please try another viewer option or download the file.
					</p>
					<object
						data="/uploads/excel/<%= filename %>"
						type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
						width="100%"
						height="500px">
						<div class="alert alert-warning mt-3">
							<i class="fas fa-exclamation-circle me-2"></i>
							Your browser doesn't support direct Excel previews. Please use
							another viewer option or download the file.
						</div>
					</object>
				</div>
			</div>
			<div
				id="viewError"
				class="p-5 text-center bg-light"
				style="display: none">
				<div class="py-5">
					<i class="fas fa-exclamation-circle fa-3x text-warning mb-3"></i>
					<h5>Unable to display the Excel file</h5>
					<p class="text-muted mb-4">
						The viewer is having trouble displaying this file. You can still
						download it to view locally.
					</p>
					<a
						href="/uploads/excel/<%= filename %>"
						class="btn btn-primary"
						download>
						<i class="fas fa-download me-2"></i>Download Excel File
					</a>
				</div>
			</div>
		</div>
	</div>

	<% if (timeReport && timeReport.versions && timeReport.versions.length > 0) {
	%>
	<div class="card mb-4">
		<div class="card-header bg-info text-white">
			<h5 class="mb-0"><i class="fas fa-history me-2"></i> Version History</h5>
		</div>
		<div class="card-body">
			<% if (timeReport.versions.length === 1) { %>
			<p class="text-muted">This is the first version of this time report.</p>
			<% } else { %>
			<div class="table-responsive">
				<table class="table table-hover">
					<thead>
						<tr>
							<th>Version</th>
							<th>Date</th>
							<th>Updated By</th>
							<th>Reason</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						<% timeReport.versions.forEach(version => { %>
						<tr>
							<td>
								<span class="badge bg-secondary"
									>v<%= version.versionNumber %></span
								>
							</td>
							<td><%= new Date(version.uploadDate).toLocaleString() %></td>
							<td>
								<% if (version.updatedBy) { %> <%= version.updatedBy.firstName
								%> <%= version.updatedBy.lastName %> <% } else { %> - <% } %>
							</td>
							<td><%= version.changeReason || 'Initial upload' %></td>
							<td>
								<% if (version.versionNumber !== timeReport.currentVersion) { %>
								<a href="#" class="btn btn-sm btn-outline-primary">View</a>
								<% } else { %>
								<span class="badge bg-success">Current</span>
								<% } %>
							</td>
						</tr>
						<% }) %>
					</tbody>
				</table>
			</div>
			<% } %> <% if (timeReport.author && timeReport.author.toString() ===
			currentUser._id.toString()) { %>
			<div class="mt-3">
				<button
					class="btn btn-outline-primary"
					data-bs-toggle="modal"
					data-bs-target="#newVersionModal">
					<i class="fas fa-upload me-1"></i> Upload New Version
				</button>
			</div>
			<% } %>
		</div>
	</div>
	<% } %>
</div>

<!-- Upload New Version Modal -->
<% if (timeReport && timeReport.author && timeReport.author.toString() ===
currentUser._id.toString()) { %>
<div
	class="modal fade"
	id="newVersionModal"
	tabindex="-1"
	aria-labelledby="newVersionModalLabel"
	aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header bg-primary text-white">
				<h5 class="modal-title" id="newVersionModalLabel">
					Upload New Version
				</h5>
				<button
					type="button"
					class="btn-close btn-close-white"
					data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form
					action="/timereport/<%= timeReport._id %>/versions"
					method="POST"
					enctype="multipart/form-data"
					id="newVersionForm">
					<div class="mb-3">
						<label for="xlsxFile" class="form-label">Select Excel File</label>
						<input
							type="file"
							class="form-control"
							id="xlsxFile"
							name="xlsxFile"
							accept=".xlsx, .xls"
							required />
						<div class="form-text">
							Only Excel files (.xlsx, .xls) are accepted.
						</div>
					</div>
					<div class="mb-3">
						<label for="changeReason" class="form-label"
							>Reason for Update</label
						>
						<textarea
							class="form-control"
							id="changeReason"
							name="changeReason"
							rows="3"
							placeholder="Describe what changes you made..."></textarea>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
					Cancel
				</button>
				<button type="submit" form="newVersionForm" class="btn btn-primary">
					Upload Version
				</button>
			</div>
		</div>
	</div>
</div>
<% } %>

<!-- Delete Confirmation Modal -->
<% if (timeReport && timeReport.author && timeReport.author.toString() ===
currentUser._id.toString()) { %>
<div
	class="modal fade"
	id="deleteConfirmModal"
	tabindex="-1"
	aria-labelledby="deleteConfirmModalLabel"
	aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header bg-danger text-white">
				<h5 class="modal-title" id="deleteConfirmModalLabel">
					<i class="fas fa-exclamation-triangle me-2"></i>
					Confirm Deletion
				</h5>
				<button
					type="button"
					class="btn-close btn-close-white"
					data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p>Are you sure you want to delete this time report?</p>
				<div class="alert alert-warning">
					<i class="fas fa-exclamation-circle me-2"></i>
					This action cannot be undone!
				</div>
				<% if (timeReport.excelFile && timeReport.excelFile.originalName) { %>
				<p>
					<strong>Excel File:</strong> <%= timeReport.excelFile.originalName %>
				</p>
				<% } %>
				<p>
					<strong>Date:</strong> <%= new
					Date(timeReport.date).toLocaleDateString() %>
				</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
					Cancel
				</button>
				<form
					action="/timereport/<%= timeReport._id %>?_method=DELETE"
					method="POST"
					class="d-inline">
					<button type="submit" class="btn btn-danger">
						<i class="fas fa-trash me-1"></i> Delete
					</button>
				</form>
			</div>
		</div>
	</div>
</div>
<% } %>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
	document.addEventListener("DOMContentLoaded", function () {
		const msViewerBtn = document.getElementById("msViewerBtn");
		const msAltViewerBtn = document.getElementById("msAltViewerBtn");
		const googleViewerBtn = document.getElementById("googleViewerBtn");
		const embedViewerBtn = document.getElementById("embedViewerBtn");
		const jsViewerBtn = document.getElementById("jsViewerBtn");

		const jsViewer = document.getElementById("jsViewer");
		const msViewer = document.getElementById("msViewer");
		const msAltViewer = document.getElementById("msAltViewer");
		const googleViewer = document.getElementById("googleViewer");
		const embedViewer = document.getElementById("embedViewer");

		const viewError = document.getElementById("viewError");
		const msOfficeFrame = document.getElementById("msOfficeFrame");
		const msAltOfficeFrame = document.getElementById("msAltOfficeFrame");
		const googleFrame = document.getElementById("googleFrame");

		// Load and display the Excel file using SheetJS
		function loadExcelWithSheetJS() {
			const loadingIndicator = document.getElementById("loading-indicator");
			const excelDataContainer = document.getElementById("excel-data");

			// Show loading indicator
			loadingIndicator.style.display = "block";
			excelDataContainer.innerHTML = "";

			// Create a download link with fallback message
			setTimeout(function () {
				// If still loading after 5 seconds, show an error/fallback
				if (loadingIndicator.style.display === "block") {
					loadingIndicator.style.display = "none";
					excelDataContainer.innerHTML = `
						<div class="alert alert-warning my-4">
							<h5><i class="fas fa-exclamation-triangle me-2"></i>Viewer is taking too long to load</h5>
							<p class="mb-3">We're having trouble displaying the Excel file in the browser.</p>
							<a href="<%= directFileUrl %>" download class="btn btn-primary">
								<i class="fas fa-download me-2"></i>Download Excel File
							</a>
						</div>
					`;
				}
			}, 5000);

			try {
				// Simple direct approach - create an iframe pointing to the file
				excelDataContainer.innerHTML = `
					<div class="text-center py-3">
						<p class="text-muted mb-3">Preview may be limited based on your browser capabilities</p>
						<div class="embed-responsive embed-responsive-16by9">
							<iframe src="<%= directFileUrl %>" width="100%" height="450" class="border-0"></iframe>
						</div>
						<div class="mt-4">
							<a href="<%= directFileUrl %>" download class="btn btn-primary">
								<i class="fas fa-download me-2"></i>Download for Best Viewing
							</a>
						</div>
					</div>
				`;
				loadingIndicator.style.display = "none";
			} catch (error) {
				console.error("Error with simplified viewer:", error);
				// Show fallback message if simplified viewer fails
				loadingIndicator.style.display = "none";
				excelDataContainer.innerHTML = `
					<div class="alert alert-danger">
						<i class="fas fa-exclamation-circle me-2"></i>
						Error loading Excel file: ${error.message}
						<div class="mt-3">
							<a href="<%= directFileUrl %>" download class="btn btn-primary">
								<i class="fas fa-download me-2"></i>Download Excel File
							</a>
						</div>
					</div>
				`;
			}
		}

		// Check Microsoft viewer after a timeout
		setTimeout(function () {
			// Start with JS viewer by default
			switchToJsViewer();
		}, 800);

		function checkAndSwitchIfNeeded() {
			// First try the standard Microsoft viewer
			if (checkIframeForErrors(msOfficeFrame)) {
				console.log(
					"Microsoft viewer showing errors, trying alternative viewer"
				);
				switchToMsAltViewer();

				// Check the alternative viewer after a delay
				setTimeout(function () {
					if (checkIframeForErrors(msAltOfficeFrame)) {
						console.log(
							"Microsoft alternative viewer showing errors, trying Google"
						);
						switchToGoogleViewer();

						// Finally try Google, then fall back to JS viewer
						setTimeout(function () {
							if (checkIframeForErrors(googleFrame)) {
								console.log("Google viewer showing errors, using JS viewer");
								switchToJsViewer();
							}
						}, 3000);
					}
				}, 3000);
			}
		}

		// More robust error checking function
		function checkIframeForErrors(frame) {
			try {
				// If we can't access the iframe content due to CORS, assume it's working
				// But check for visible indicators that suggest an error
				const frameHeight = frame.clientHeight;
				const frameVisible = frame.offsetParent !== null;
				const frameLoaded =
					frame.complete !== undefined ? frame.complete : true;

				// Also check if the iframe has a src attribute and it's not empty
				const hasSrc = frame.src && frame.src.length > 0;

				return !frameLoaded || !frameVisible || frameHeight < 100 || !hasSrc;
			} catch (e) {
				console.log("Error checking iframe:", e);
				// If there's an error checking, we'll assume the frame is OK
				return false;
			}
		}

		// Add event listener for JS viewer button
		jsViewerBtn.addEventListener("click", function () {
			switchToJsViewer();
		});

		msViewerBtn.addEventListener("click", function () {
			switchToMsViewer();
		});

		msAltViewerBtn.addEventListener("click", function () {
			switchToMsAltViewer();
		});

		googleViewerBtn.addEventListener("click", function () {
			switchToGoogleViewer();
		});

		embedViewerBtn.addEventListener("click", function () {
			switchToEmbedViewer();
		});

		function switchToJsViewer() {
			jsViewer.style.display = "block";
			msViewer.style.display = "none";
			msAltViewer.style.display = "none";
			googleViewer.style.display = "none";
			embedViewer.style.display = "none";
			viewError.style.display = "none";

			jsViewerBtn.classList.add("active");
			msViewerBtn.classList.remove("active");
			msAltViewerBtn.classList.remove("active");
			googleViewerBtn.classList.remove("active");
			embedViewerBtn.classList.remove("active");

			// Load the Excel file
			loadExcelWithSheetJS();
		}

		function switchToMsViewer() {
			jsViewer.style.display = "none";
			msViewer.style.display = "block";
			msAltViewer.style.display = "none";
			googleViewer.style.display = "none";
			embedViewer.style.display = "none";
			viewError.style.display = "none";

			jsViewerBtn.classList.remove("active");
			msViewerBtn.classList.add("active");
			msAltViewerBtn.classList.remove("active");
			googleViewerBtn.classList.remove("active");
			embedViewerBtn.classList.remove("active");
		}

		function switchToMsAltViewer() {
			jsViewer.style.display = "none";
			msViewer.style.display = "none";
			msAltViewer.style.display = "block";
			googleViewer.style.display = "none";
			embedViewer.style.display = "none";
			viewError.style.display = "none";

			jsViewerBtn.classList.remove("active");
			msViewerBtn.classList.remove("active");
			msAltViewerBtn.classList.add("active");
			googleViewerBtn.classList.remove("active");
			embedViewerBtn.classList.remove("active");
		}

		function switchToGoogleViewer() {
			jsViewer.style.display = "none";
			msViewer.style.display = "none";
			msAltViewer.style.display = "none";
			googleViewer.style.display = "block";
			embedViewer.style.display = "none";
			viewError.style.display = "none";

			jsViewerBtn.classList.remove("active");
			msViewerBtn.classList.remove("active");
			msAltViewerBtn.classList.remove("active");
			googleViewerBtn.classList.add("active");
			embedViewerBtn.classList.remove("active");
		}

		function switchToEmbedViewer() {
			jsViewer.style.display = "none";
			msViewer.style.display = "none";
			msAltViewer.style.display = "none";
			googleViewer.style.display = "none";
			embedViewer.style.display = "block";
			viewError.style.display = "none";

			jsViewerBtn.classList.remove("active");
			msViewerBtn.classList.remove("active");
			msAltViewerBtn.classList.remove("active");
			googleViewerBtn.classList.remove("active");
			embedViewerBtn.classList.add("active");
		}

		// Monitor for errors in iframes
		msOfficeFrame.addEventListener("error", function () {
			switchToMsAltViewer();
		});

		msAltOfficeFrame.addEventListener("error", function () {
			switchToGoogleViewer();
		});

		googleFrame.addEventListener("error", function () {
			switchToJsViewer();
		});
	});
</script>
