<%- layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/dashboard.css" />
<link rel="stylesheet" href="/css/weeklyReportsIndex.css" />
<link rel="stylesheet" href="/css/customModal.css" />
<script src="/js/reportTooltips.js" defer></script>

<style>
  .filter-card {
    border-radius: 8px;
    box-shadow: 0 0 15px rgba(0,0,0,0.05);
    background-color: #fff;
    overflow: hidden;
    border: 1px solid #eaeaea;
    margin-bottom: 1.5rem;
  }
  
  .filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #eaeaea;
  }
  
  .filter-header h4 {
    margin: 0;
    font-size: 1.1rem;
    color: #495057;
    font-weight: 600;
  }
  
  .filter-body {
    padding: 20px;
    display: none;
  }
  
  .filter-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
  }
  
  .current-user-report {
    background-color: rgba(13, 110, 253, 0.1);
  }
  
  .your-report-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background-color: #0d6efd;
    color: white;
    border-radius: 50%;
    margin-right: 8px;
    font-size: 12px;
  }
  
  .your-name {
    font-weight: 600;
    color: #0d6efd;
  }
  
  .action-buttons {
    display: flex;
    gap: 5px;
  }
  
  .status-badge {
    display: inline-block;
    margin-bottom: 3px;
  }
</style>

<div class="container mt-4">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h1>Time Reports</h1>
		<a href="/timereport/new" class="btn btn-primary"
			><i class="fas fa-plus"></i> Upload Time Report (Excel)</a
		>
	</div>
	
	<!-- Filter Section -->
	<div class="filter-card mb-4">
		<div class="filter-header">
			<h4><i class="fas fa-filter me-2"></i>Filter Reports</h4>
			<button class="btn btn-sm btn-outline-secondary" id="toggleFilters">
				<i class="fas fa-chevron-up"></i>
			</button>
		</div>
		<div class="filter-body" id="filterBody">
			<form id="filterForm" class="row g-3" method="GET" action="/timereport">
				<div class="col-md-4 col-lg-3">
					<label for="studentName" class="form-label">Student Name</label>
					<input
						type="text"
						class="form-control"
						id="studentName"
						name="studentName"
						value="<%= filters?.studentName || '' %>"
						placeholder="Search by name" />
				</div>
				<div class="col-md-4 col-lg-3">
					<label for="internshipSite" class="form-label">Internship Site</label>
					<input
						type="text"
						class="form-control"
						id="internshipSite"
						name="internshipSite"
						value="<%= filters?.internshipSite || '' %>"
						placeholder="Search by site" />
				</div>
				<div class="col-md-4 col-lg-2">
					<label for="weekNumber" class="form-label">Week Number</label>
					<select class="form-select" id="weekNumber" name="weekNumber">
						<option value="">All Weeks</option>
						<% for(let i = 1; i <= 24; i++) { %>
						<option value="<%= i %>" <%= filters?.weekNumber == i ? 'selected' : '' %>>Week <%= i %></option>
						<% } %>
					</select>
				</div>
				<div class="col-md-4 col-lg-2">
					<label for="archived" class="form-label">Archive Status</label>
					<select class="form-select" id="archived" name="archived">
						<option value="" <%= !filters?.archived ? 'selected' : '' %>>All Reports</option>
						<option value="false" <%= filters?.archived === 'false' ? 'selected' : '' %>>Active Only</option>
						<option value="true" <%= filters?.archived === 'true' ? 'selected' : '' %>>Archived Only</option>
					</select>
				</div>
				<div class="col-md-4 col-lg-2">
					<label for="sortBy" class="form-label">Sort By</label>
					<select class="form-select" id="sortBy" name="sortBy">
						<option value="date_desc" <%= !filters?.sortBy || filters?.sortBy === 'date_desc' ? 'selected' : '' %>>Newest First</option>
						<option value="date_asc" <%= filters?.sortBy === 'date_asc' ? 'selected' : '' %>>Oldest First</option>
						<option value="studentName_asc" <%= filters?.sortBy === 'studentName_asc' ? 'selected' : '' %>>Name (A-Z)</option>
						<option value="studentName_desc" <%= filters?.sortBy === 'studentName_desc' ? 'selected' : '' %>>Name (Z-A)</option>
						<option value="internshipSite_asc" <%= filters?.sortBy === 'internshipSite_asc' ? 'selected' : '' %>>Site (A-Z)</option>
						<option value="weekNumber_asc" <%= filters?.sortBy === 'weekNumber_asc' ? 'selected' : '' %>>Week (Ascending)</option>
						<option value="weekNumber_desc" <%= filters?.sortBy === 'weekNumber_desc' ? 'selected' : '' %>>Week (Descending)</option>
					</select>
				</div>
				<div class="col-12 filter-actions">
					<button type="submit" class="btn btn-primary">
						<i class="fas fa-search me-1"></i> Apply Filters
					</button>
					<a href="/timereport" class="btn btn-outline-secondary">
						<i class="fas fa-times me-1"></i> Clear Filters
					</a>
				</div>
			</form>
		</div>
	</div>
	
	<div class="card shadow-sm">
		<div class="card-body">
			<h4 class="mb-3">Your Time Reports</h4>
			<% if (timeReports && timeReports.length) { %>
			<div class="table-responsive">
				<table class="table table-hover report-table">
					<thead class="table-light">
						<tr>
							<th>Student's Name</th>
							<th>Internship Site</th>
							<th>Week #</th>
							<th>Week Period</th>
							<th>Status</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						<% timeReports.forEach(function(report) { %>
						<tr class="<%= report.author && report.author.toString() === currentUser._id.toString() ? 'current-user-report' : '' %>">
							<td>
								<div class="d-flex align-items-center">
									<% if (report.author && report.author.toString() === currentUser._id.toString()) { %>
									<span class="your-report-badge" data-bs-toggle="tooltip" title="This is your report">
										<i class="fas fa-user-check"></i>
									</span>
									<span class="student-name your-name"><%= report.studentName || 'N/A' %></span>
									<% } else { %>
									<span class="student-name"><%= report.studentName || 'N/A' %></span>
									<% } %>
								</div>
							</td>
							<td><%= report.internshipSite || 'N/A' %></td>
							<td>
								<% if (report.weekNumber) { %>
									<span class="badge bg-info">Week <%= report.weekNumber %></span>
								<% } else { %>
									N/A
								<% } %>
							</td>
							<td>
								<% if (report.weekStartDate && report.weekEndDate) { %>
									<span class="text-nowrap">
										<%= new Date(report.weekStartDate).toLocaleDateString() %> - 
										<%= new Date(report.weekEndDate).toLocaleDateString() %>
									</span>
								<% } else { %>
									N/A
								<% } %>
							</td>
							<td>
								<% if (report.archived) { %>
									<div class="status-badge">
										<span class="badge bg-secondary">
											<i class="fas fa-archive me-1"></i> Archived
										</span>
									</div>
								<% } else { %>
									<div class="status-badge">
										<span class="badge bg-success">
											<i class="fas fa-check-circle me-1"></i> Active
										</span>
									</div>
								<% } %>
							</td>
							<td>
								<div class="action-buttons">
									<a
										href="/timereport/<%= report._id %>"
										class="btn btn-sm btn-info text-white"
										data-bs-toggle="tooltip"
										title="View Report">
										<i class="fas fa-eye"></i>
									</a>
									<% if (report.excelFile && report.excelFile.filename) { %>
										<a
											href="/uploads/excel/<%= report.excelFile.filename %>"
											class="btn btn-sm btn-success"
											title="Download Excel"
											data-bs-toggle="tooltip"
											target="_blank">
											<i class="fas fa-download"></i>
										</a>
									<% } %>
									<% if (report.author && report.author.toString() === currentUser._id.toString()) { %>
										<button 
											type="button" 
											class="btn btn-sm btn-danger"
											data-bs-toggle="modal"
											data-bs-target="#deleteConfirmModal<%= report._id %>"
											title="Delete Report">
											<i class="fas fa-trash"></i>
										</button>
									<% } %>
								</div>
							</td>
						</tr>
						<% }) %>
					</tbody>
				</table>
			</div>

			<!-- Pagination could be added here if needed -->

			<% } else { %>
			<div class="alert alert-info text-center">
				<i class="fas fa-info-circle me-2"></i>
				<% if (typeof filters !== 'undefined' && filters && Object.keys(filters).length > 0 && Object.keys(filters).some(function(key) { return filters[key] && key !== 'page' && key !== 'limit'; })) { %>
					No reports found matching your filters. <a href="/timereport" class="alert-link">Clear filters</a> to see all reports.
				<% } else { %>
					No time reports available yet.
				<% } %>
			</div>
			<% } %>
		</div>
	</div>
</div>

<!-- Delete Confirmation Modals -->
<% if (timeReports && timeReports.length) { %>
  <% timeReports.forEach(function(report) { %>
    <% if (report.author && report.author.toString() === currentUser._id.toString()) { %>
      <div class="modal fade" id="deleteConfirmModal<%= report._id %>" tabindex="-1" aria-labelledby="deleteConfirmModalLabel<%= report._id %>" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title" id="deleteConfirmModalLabel<%= report._id %>">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Confirm Deletion
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete this time report?</p>
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-circle me-2"></i>
                This action cannot be undone!
              </div>
              <% if (report.excelFile && report.excelFile.originalName) { %>
                <p><strong>Excel File:</strong> <%= report.excelFile.originalName %></p>
              <% } %>
              <p><strong>Date:</strong> <%= new Date(report.date).toLocaleDateString() %></p>
              
              <!-- Password Confirmation -->
              <form action="/timereport/<%= report._id %>?_method=DELETE" method="POST" id="deleteForm<%= report._id %>">
                <div class="form-group mb-3">
                  <label for="password<%= report._id %>" class="form-label">
                    <strong>Enter your password to confirm:</strong>
                  </label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                    <input
                      type="password"
                      class="form-control"
                      id="password<%= report._id %>"
                      name="password"
                      placeholder="Enter your password"
                      required />
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" form="deleteForm<%= report._id %>" class="btn btn-danger">
                <i class="fas fa-trash me-1"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    <% } %>
  <% }) %>
<% } %>

<!-- Filter Toggle Script -->
<script>
	document.addEventListener('DOMContentLoaded', function() {
		const toggleFiltersBtn = document.getElementById('toggleFilters');
		const filterBody = document.getElementById('filterBody');
		
		// Initialize tooltips
		const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
		tooltipTriggerList.map(function (tooltipTriggerEl) {
			return new bootstrap.Tooltip(tooltipTriggerEl, {
				boundary: document.body
			});
		});

		// Toggle filters when the button is clicked
		toggleFiltersBtn.addEventListener('click', function(e) {
			e.preventDefault();
			if (filterBody.style.display === 'block') {
				filterBody.style.display = 'none';
				toggleFiltersBtn.querySelector('i').classList.remove('fa-chevron-down');
				toggleFiltersBtn.querySelector('i').classList.add('fa-chevron-up');
			} else {
				filterBody.style.display = 'block';
				toggleFiltersBtn.querySelector('i').classList.remove('fa-chevron-up');
				toggleFiltersBtn.querySelector('i').classList.add('fa-chevron-down');
			}
		});
	});
</script>
